FROM pytorch/pytorch:2.10.0-cuda13.0-cudnn9-runtime

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# System deps: LaTeX, biber, chktex, git, curl, jq
# (Python 3.12 + PyTorch + CUDA are already in the base image)
RUN apt-get update && apt-get install -y --no-install-recommends \
    texlive-latex-base texlive-latex-recommended texlive-fonts-recommended \
    texlive-latex-extra biber chktex curl jq git git-lfs poppler-utils && \
    git lfs install && \
    rm -rf /var/lib/apt/lists/*

# The new PyTorch base image uses system-managed Python (PEP 668).
# Remove the marker so pip/uv can install packages system-wide in the container.
RUN rm -f /usr/lib/python3.12/EXTERNALLY-MANAGED

# Install Node.js 22.x + Claude Code CLI (used as reviewer subagent,
# independent of which main agent runtime — Gemini, Codex, etc. — is driving)
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y --no-install-recommends nodejs && \
    npm install -g @anthropic-ai/claude-code && \
    rm -rf /var/lib/apt/lists/*

# Install uv for fast, reproducible Python package management
RUN pip install --no-cache-dir uv

# Additional Python deps for ML research + dataset access
# (numpy, torch, torchvision already in base image)
RUN uv pip install --system --no-cache \
    pandas scikit-learn matplotlib seaborn scipy \
    datasets huggingface-hub

WORKDIR /app

# Copy repo templates (staged into build context by run.sh)
COPY blank_icbinb_latex/ /app/blank_icbinb_latex/
COPY scripts/ /app/scripts/
COPY .claude/ /app/.claude/

# Create workspace structure and pre-fill LaTeX template
RUN mkdir -p /app/experiment_codebase/baselines /app/experiment_codebase/main \
    /app/experiment_codebase/ablations /app/experiment_codebase/plotting \
    /app/experiment_codebase/cloned_repos \
    /app/figures /app/latex /app/literature /app/submissions && \
    cp -r /app/blank_icbinb_latex/* /app/latex/ && \
    chmod +x /app/scripts/submit_for_review.sh

# Pre-initialize git repo so agent starts with version control ready.
# Remote + branch are configured at runtime by the patched agent wrapper.
COPY .gitignore.agent /app/.gitignore
RUN git config --global user.email "ai-scientist-agent@noreply.gitlab.com" && \
    git config --global user.name "AI Scientist Agent" && \
    git config --global init.defaultBranch main && \
    git init /app

# Copy previous artifacts if resuming (always exists, may be empty)
COPY prev_artifacts/ /app/prev_artifacts/
RUN set +e; \
    if [ "$(ls -A /app/prev_artifacts 2>/dev/null)" ]; then \
        cp -r /app/prev_artifacts/experiment_codebase/* /app/experiment_codebase/ 2>/dev/null; \
        cp -r /app/prev_artifacts/figures/* /app/figures/ 2>/dev/null; \
        cp /app/prev_artifacts/paper.tex /app/latex/template.tex 2>/dev/null; \
        cp /app/prev_artifacts/paper.pdf /app/latex/template.pdf 2>/dev/null; \
        cp /app/prev_artifacts/review.json /app/review.json 2>/dev/null; \
        cp -r /app/prev_artifacts/literature/* /app/literature/ 2>/dev/null; \
        cp -r /app/prev_artifacts/submissions/* /app/submissions/ 2>/dev/null; \
        # Restore dependencies from previous run's snapshot
        if [ -f /app/prev_artifacts/requirements.txt ]; then \
            uv pip install --system --no-cache -r /app/prev_artifacts/requirements.txt 2>/dev/null; \
        fi; \
    fi; \
    rm -rf /app/prev_artifacts; \
    exit 0
