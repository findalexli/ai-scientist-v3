<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Job Detail — AI Scientist v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<style>
:root {
  --bg0: #070b0f;
  --bg1: #0d1420;
  --bg2: #101c2b;
  --surface: #121b2a;
  --surface2: #1a2638;
  --surface3: #22344a;
  --border: #2f4761;
  --text: #edf4ff;
  --text-dim: #9eb3cb;
  --accent: #35c2ff;
  --accent-2: #4ce0b3;
  --warm: #ffbf69;
  --danger: #ff7e7e;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Manrope', sans-serif;
  color: var(--text);
  background:
    radial-gradient(1200px 500px at 0% -10%, rgba(53,194,255,0.2), transparent 60%),
    radial-gradient(900px 480px at 100% 0%, rgba(76,224,179,0.14), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg0));
  min-height: 100vh;
  line-height: 1.55;
}

.page {
  max-width: 1520px;
  margin: 0 auto;
  padding: 18px 18px 36px;
}

.header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 14px 18px;
  border: 1px solid var(--border);
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(18,27,42,0.95), rgba(18,27,42,0.76));
  backdrop-filter: blur(6px);
  box-shadow: 0 14px 40px rgba(0,0,0,0.35);
}
.header a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
}
.header h1 {
  font-size: 18px;
  font-weight: 800;
  letter-spacing: 0.02em;
}
.header-stats {
  margin-left: auto;
  display: flex;
  gap: 20px;
  align-items: center;
}
.stat {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  text-transform: uppercase;
  font-size: 10px;
  letter-spacing: 0.1em;
  color: var(--text-dim);
}
.stat .val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -0.02em;
  color: var(--text);
}
.stat .val.cost { color: var(--warm); }

.status-badge, .model-badge {
  border-radius: 999px;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}
.status-badge.running { color: #66f0a2; background: rgba(76,224,179,0.18); }
.status-badge.completed { color: #bcd0e5; background: rgba(158,179,203,0.18); }
.status-badge.idle { color: var(--warm); background: rgba(255,191,105,0.18); }
.status-badge.unknown { color: #c6d2df; background: rgba(158,179,203,0.1); }
.model-badge { background: rgba(53,194,255,0.16); color: var(--accent); }

.tab-switcher {
  margin-top: 12px;
  display: flex;
  gap: 8px;
}
.help-strip {
  margin-top: 10px;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-dim);
  font-size: 12px;
  background: rgba(26,38,56,0.5);
}
.tab-btn {
  border: 1px solid var(--border);
  background: rgba(30,48,70,0.54);
  color: var(--text-dim);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  border-radius: 999px;
  padding: 7px 12px;
  cursor: pointer;
}
.tab-btn.active {
  background: rgba(53,194,255,0.24);
  color: #fff;
  border-color: var(--accent);
}

.tab-panel {
  margin-top: 14px;
  display: none;
}
.tab-panel.active { display: block; }

.idea-card {
  margin-bottom: 12px;
  overflow: hidden;
}
.idea-head {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
  padding: 11px 12px;
  border-bottom: 1px solid var(--border);
}
.idea-meta {
  margin-top: 3px;
  color: var(--text-dim);
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  word-break: break-word;
}
.idea-content {
  max-height: 290px;
  overflow: auto;
  padding: 10px 12px;
  background: rgba(8,13,20,0.62);
}
.idea-json {
  margin: 0;
  color: #dbe9fb;
  font-size: 12px;
  line-height: 1.5;
  font-family: 'JetBrains Mono', monospace;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
}
.idea-doc {
  display: grid;
  gap: 10px;
}
.idea-field {
  border: 1px solid rgba(47,71,97,0.85);
  border-radius: 8px;
  background: rgba(16,27,43,0.62);
  overflow: hidden;
}
.idea-key {
  font-size: 11px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--accent-2);
  padding: 7px 10px;
  border-bottom: 1px solid rgba(47,71,97,0.75);
  background: rgba(18,30,47,0.82);
}
.idea-val {
  padding: 8px 10px;
}
.idea-obj {
  display: grid;
  gap: 8px;
}
.idea-array {
  display: grid;
  gap: 8px;
}
.idea-arr-item {
  border: 1px solid rgba(47,71,97,0.68);
  border-radius: 7px;
  padding: 7px 8px;
  background: rgba(12,20,32,0.58);
}
.idea-arr-label {
  font-size: 10px;
  color: var(--text-dim);
  letter-spacing: 0.05em;
  text-transform: uppercase;
  margin-bottom: 4px;
}
.idea-str {
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  font-size: 13px;
  color: var(--text);
}
.idea-primitive {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: #dbe9fb;
}
.idea-empty {
  font-size: 12px;
  color: var(--text-dim);
  font-style: italic;
}

.main {
  display: grid;
  grid-template-columns: minmax(0, 1fr) 390px;
  gap: 14px;
  align-items: start;
}

.card {
  border: 1px solid var(--border);
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(18,27,42,0.92), rgba(17,26,40,0.72));
  box-shadow: 0 10px 30px rgba(0,0,0,0.28);
}

.timeline-card { min-height: 72vh; }
.timeline-top {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
}
.timeline-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.tf-btn {
  border: 1px solid var(--border);
  background: rgba(30,48,70,0.54);
  color: var(--text-dim);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.03em;
  border-radius: 999px;
  padding: 5px 10px;
  cursor: pointer;
  transition: all 0.15s ease;
}
.tf-btn:hover { border-color: var(--accent); color: #fff; }
.tf-btn.active { box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset; }

.timeline-panel {
  max-height: 72vh;
  overflow: auto;
  padding: 12px;
}

.event {
  border: 1px solid var(--border);
  border-left: 3px solid var(--border);
  border-radius: 10px;
  background: rgba(20,31,48,0.88);
  padding: 8px 10px;
  margin-bottom: 7px;
  cursor: pointer;
  transition: background 0.12s ease, border-color 0.12s ease;
}
.event:hover { background: rgba(28,42,63,0.96); }
.event.selected {
  border-color: rgba(53,194,255,0.7);
  box-shadow: 0 0 0 1px rgba(53,194,255,0.22) inset;
}
.event-header {
  display: flex;
  align-items: center;
  gap: 8px;
}
.event-step {
  min-width: 36px;
  font-size: 10px;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
}
.event-type-tag {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  border-radius: 999px;
  padding: 2px 8px;
}
.event-summary {
  font-size: 12.5px;
  color: var(--text);
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.event-tokens {
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
}
.event-detail {
  margin-top: 7px;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid rgba(53,194,255,0.2);
  background: rgba(8,13,20,0.62);
  color: #bbd0e8;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  white-space: pre-wrap;
  word-break: break-word;
  display: none;
  max-height: 260px;
  overflow: auto;
}
.event.expanded .event-detail { display: block; }

.ev-literature_review { border-left-color: #9e8dff !important; }
.ev-submission { border-left-color: #ff6f91 !important; }
.ev-experiment { border-left-color: #4ce0b3 !important; }
.ev-paper_write { border-left-color: #35c2ff !important; }
.ev-plotting { border-left-color: #5de0ff !important; }
.ev-git_clone, .ev-pip_install { border-left-color: #ffbf69 !important; }
.ev-bash, .ev-file_read, .ev-file_write, .ev-text, .ev-thinking, .ev-task_mgmt { border-left-color: #6f859f !important; }
.ev-web, .ev-user_message { border-left-color: var(--warm) !important; }
.ev-tool_result { border-left-color: #466584 !important; }
.ev-system { border-left-color: var(--accent) !important; }
.ev-subagent { border-left-color: #ff9f87 !important; }

.side {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.panel {
  padding: 12px;
}
.panel-title {
  font-size: 11px;
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 8px;
}
.chart-container { position: relative; height: 190px; }
.donut-container { position: relative; height: 170px; }

.tool-table { width: 100%; font-size: 12px; }
.tool-table td { padding: 2px 4px; }
.tool-table td:nth-child(2), .tool-table td:nth-child(3) {
  text-align: right;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
}

.submissions-layout {
  display: grid;
  grid-template-columns: 320px minmax(0, 1fr);
  gap: 14px;
  align-items: start;
}
.submissions-nav {
  padding: 12px;
  max-height: 76vh;
  overflow: auto;
}
.sub-nav-list {
  display: flex;
  flex-direction: column;
  gap: 7px;
}
.sub-nav-item {
  border: 1px solid var(--border);
  border-radius: 10px;
  background: rgba(17,28,43,0.72);
  color: var(--text);
  width: 100%;
  text-align: left;
  padding: 9px 10px;
  cursor: pointer;
}
.sub-nav-item:hover { border-color: rgba(53,194,255,0.5); }
.sub-nav-item.active {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(53,194,255,0.25) inset;
  background: rgba(30,48,70,0.76);
}
.sub-nav-top {
  display: flex;
  align-items: center;
  gap: 8px;
}
.sub-nav-version {
  font-size: 11px;
  font-weight: 800;
  letter-spacing: 0.06em;
  color: var(--accent-2);
}
.sub-nav-time {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 2px;
}

.submission-dossier {
  padding: 14px;
  min-height: 76vh;
}
.dossier-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.dossier-title {
  font-size: 14px;
  font-weight: 800;
  letter-spacing: 0.06em;
  text-transform: uppercase;
}
.dossier-title-sub {
  font-size: 11px;
  color: var(--text-dim);
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.submission-entry {
  border: 1px solid var(--border);
  border-radius: 12px;
  background: rgba(17,28,43,0.72);
  overflow: hidden;
}
.entry-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  background: rgba(26,38,56,0.65);
}
.sub-version {
  background: rgba(76,224,179,0.2);
  color: var(--accent-2);
  font-size: 11px;
  font-weight: 800;
  border-radius: 999px;
  padding: 3px 10px;
}
.sub-time {
  font-size: 12px;
  color: var(--text-dim);
}
.sub-mode {
  margin-left: auto;
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 999px;
  background: rgba(53,194,255,0.2);
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.submission-body {
  padding: 12px;
  display: grid;
  gap: 12px;
}
.paper-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.pdf-btn {
  border: 1px solid var(--border);
  border-radius: 999px;
  background: rgba(53,194,255,0.16);
  color: var(--accent);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 6px 10px;
  cursor: pointer;
}
.pdf-btn:hover { border-color: var(--accent); }
.pdf-link {
  color: var(--accent);
  text-decoration: none;
  font-size: 12px;
  font-weight: 600;
}
.pdf-link:hover { text-decoration: underline; }
.paper-wrap {
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  background: rgba(8,13,20,0.68);
}
.paper-wrap iframe {
  border: 0;
  width: 100%;
  min-height: 420px;
  background: #fff;
}
.paper-empty {
  padding: 16px;
  color: var(--text-dim);
  font-size: 12px;
}
.pdfjs-toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  background: rgba(18,27,42,0.82);
}
.pdfjs-status {
  color: var(--text-dim);
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
}
.pdfjs-spacer { flex: 1; }
.pdfjs-canvas-wrap {
  padding: 10px;
  display: flex;
  justify-content: center;
  overflow: auto;
}
.pdfjs-canvas {
  max-width: 100%;
  height: auto;
  box-shadow: 0 10px 24px rgba(0,0,0,0.34);
  background: #fff;
}
.pdf-fallback-note {
  padding: 8px 10px;
  border-top: 1px solid var(--border);
  color: var(--text-dim);
  font-size: 11px;
}

.md-section {
  border: 1px solid var(--border);
  border-radius: 10px;
  background: rgba(8,13,20,0.55);
  padding: 10px;
}
.md-section h4 {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-dim);
  margin-bottom: 8px;
}
.md-content {
  font-size: 13px;
  color: var(--text);
}
.md-content p { margin: 0 0 8px; }
.md-content p:last-child { margin-bottom: 0; }
.md-content pre {
  background: rgba(7,11,15,0.85);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  overflow: auto;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
}
.md-content code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
}
.md-content a {
  color: var(--accent);
  text-decoration: none;
}
.md-content ul, .md-content ol {
  margin: 0 0 8px 18px;
}
.md-empty {
  color: var(--text-dim);
  font-size: 12px;
}

.sub-badges { display: flex; gap: 6px; flex-wrap: wrap; }
.sub-badge {
  font-size: 10px;
  border-radius: 999px;
  padding: 2px 8px;
  border: 1px solid var(--border);
  color: var(--text-dim);
}

.no-data {
  padding: 20px;
  text-align: center;
  color: var(--text-dim);
}

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-thumb { background: #385470; border-radius: 999px; }

@media (max-width: 1100px) {
  .submissions-layout { grid-template-columns: 1fr; }
  .submissions-nav { max-height: none; }
  .main { grid-template-columns: 1fr; }
  .timeline-card { min-height: 54vh; }
  .timeline-panel { max-height: 54vh; }
}

@media (max-width: 760px) {
  .header {
    flex-wrap: wrap;
    gap: 10px;
    padding: 12px;
  }
  .header-stats {
    margin-left: 0;
    width: 100%;
    justify-content: space-between;
  }
  .stat { align-items: flex-start; }
  .stat .val { font-size: 16px; }
  .paper-wrap iframe { min-height: 340px; }
}
</style>
</head>
<body>
<div class="page">
  <div class="header">
    <a href="/">&larr; All Jobs</a>
    <h1 id="job-title">{{JOB_ID}}</h1>
    <span class="status-badge" id="status-badge">...</span>
    <span class="model-badge" id="model-badge">...</span>
    <a id="gitlab-link" href="#" target="_blank" rel="noopener" style="display:none; margin-left:8px; font-size:12px; color:#fc6d26; text-decoration:none; border:1px solid rgba(252,109,38,0.3); border-radius:999px; padding:4px 10px;">GitLab</a>
    <div class="header-stats">
      <div class="stat"><span class="val" id="stat-events">-</span>events</div>
      <div class="stat"><span class="val" id="stat-tokens">-</span>tokens</div>
      <div class="stat"><span class="val cost" id="stat-cost">-</span>est. cost</div>
      <div class="stat"><span class="val" id="stat-subs">-</span>submissions</div>
    </div>
  </div>

  <div class="tab-switcher">
    <button class="tab-btn active" data-tab="submissions">Submissions</button>
    <button class="tab-btn" data-tab="trajectory">Trajectory</button>
  </div>
  <div class="help-strip">Job: one full run. Trajectory: chronological agent actions. Submission: a saved paper version with review and rebuttal.</div>

  <div class="tab-panel" id="tab-trajectory">
    <div class="card idea-card">
      <div class="idea-head">
        <div>
          <div class="panel-title">Model Input — Original Idea JSON</div>
          <div class="idea-meta" id="idea-meta">Resolving idea source…</div>
        </div>
        <button class="pdf-btn" id="idea-view-toggle" style="display:none;">Show Raw JSON</button>
      </div>
      <div class="idea-content" id="idea-content">
        <div class="no-data">Loading idea input…</div>
      </div>
    </div>

    <div class="main">
      <div class="card timeline-card">
        <div class="timeline-top">
          <div class="timeline-filters" id="timeline-filters"></div>
        </div>
        <div class="timeline-panel" id="timeline-panel">
          <div id="timeline"></div>
        </div>
      </div>

      <div class="side">
        <div class="card panel">
          <div class="panel-title">Cumulative Token Usage</div>
          <div class="chart-container"><canvas id="token-chart"></canvas></div>
        </div>

        <div class="card panel">
          <div class="panel-title">Tool Breakdown</div>
          <div class="donut-container"><canvas id="tool-chart"></canvas></div>
          <table class="tool-table" id="tool-table"></table>
        </div>

        <div class="card panel">
          <div class="panel-title">Activity Breakdown</div>
          <div class="donut-container"><canvas id="activity-chart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-panel active" id="tab-submissions">
    <div class="submissions-layout">
      <div class="card submissions-nav">
        <div class="panel-title">Submission Versions</div>
        <div id="submissions-list-nav"><div class="no-data">Loading submissions...</div></div>
      </div>
      <div class="card submission-dossier">
        <div class="dossier-head">
          <div>
            <div class="dossier-title">Submission Dossier</div>
            <div class="dossier-title-sub" id="dossier-meta">Select a submission version.</div>
          </div>
        </div>
        <div id="submissions-dossier"><div class="no-data">Select a submission from the left.</div></div>
      </div>
    </div>
  </div>
</div>

<script>
const JOB_ID = '{{JOB_ID}}';
let allEvents = [];
let lastStep = 0;
let activeFilters = new Set();
let tokenChart = null;
let toolChart = null;
let activityChart = null;
let isLive = false;
let evtSource = null;
let selectedEvent = null;
let tokenRefreshTimer = null;
let submissionsCache = [];
let submissionsLoaded = false;
let selectedSubmissionIdx = -1;
let activeTab = 'submissions';
let ideaRawText = '';
let ideaPrettyHtml = '';
let ideaCanToggle = false;
let ideaViewMode = 'pretty';
let pdfJsLoadPromise = null;

const PDFJS_SRC = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';

const EVENT_TYPES = {
  literature_review: { label: 'Literature', color: '#9e8dff' },
  submission: { label: 'Submission', color: '#ff6f91' },
  experiment: { label: 'Experiment', color: '#4ce0b3' },
  paper_write: { label: 'Paper', color: '#35c2ff' },
  plotting: { label: 'Plotting', color: '#5de0ff' },
  git_clone: { label: 'Git', color: '#ffbf69' },
  pip_install: { label: 'Install', color: '#ffbf69' },
  bash: { label: 'Bash', color: '#6f859f' },
  web: { label: 'Web', color: '#ffbf69' },
  file_read: { label: 'Read', color: '#6f859f' },
  file_write: { label: 'Write', color: '#6f859f' },
  subagent: { label: 'Subagent', color: '#ff9f87' },
  thinking: { label: 'Thinking', color: '#6f859f' },
  text: { label: 'Text', color: '#6f859f' },
  tool_result: { label: 'Result', color: '#466584' },
  task_mgmt: { label: 'TaskMgmt', color: '#6f859f' },
  system: { label: 'System', color: '#35c2ff' },
  user_message: { label: 'User', color: '#ffbf69' },
  other: { label: 'Other', color: '#30363d' },
};

function formatTokens(n) {
  if (!n) return '-';
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1_000) return (n / 1_000).toFixed(0) + 'K';
  return String(n);
}

function formatTimestamp(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return ts;
  return d.toLocaleString();
}

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderMarkdown(text) {
  if (!text || !text.trim()) return '<p class="md-empty">No content provided.</p>';
  let html = '';
  if (window.marked) {
    html = marked.parse(text, { breaks: true, gfm: true, mangle: false, headerIds: false });
  } else {
    html = escHtml(text).replace(/\n/g, '<br>');
  }
  if (window.DOMPurify) {
    html = DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
  }
  return html;
}

function renderIdeaNode(value, depth = 0) {
  if (value === null) return '<div class="idea-empty">null</div>';

  const t = typeof value;
  if (t === 'string') {
    return `<div class="idea-str">${escHtml(value)}</div>`;
  }
  if (t === 'number' || t === 'boolean') {
    return `<div class="idea-primitive">${escHtml(String(value))}</div>`;
  }
  if (Array.isArray(value)) {
    if (!value.length) return '<div class="idea-empty">[]</div>';
    return `
      <div class="idea-array">
        ${value.map((item, idx) => `
          <div class="idea-arr-item">
            <div class="idea-arr-label">Item ${idx + 1}</div>
            ${renderIdeaNode(item, depth + 1)}
          </div>
        `).join('')}
      </div>
    `;
  }
  if (t === 'object') {
    const entries = Object.entries(value);
    if (!entries.length) return '<div class="idea-empty">{}</div>';
    return `
      <div class="idea-obj">
        ${entries.map(([k, v]) => `
          <div class="idea-field">
            <div class="idea-key">${escHtml(k)}</div>
            <div class="idea-val">${renderIdeaNode(v, depth + 1)}</div>
          </div>
        `).join('')}
      </div>
    `;
  }
  return `<div class="idea-primitive">${escHtml(String(value))}</div>`;
}

function updateIdeaView() {
  const content = document.getElementById('idea-content');
  const toggle = document.getElementById('idea-view-toggle');
  if (!content || !toggle) return;

  if (!ideaCanToggle) {
    toggle.style.display = 'none';
    content.innerHTML = `<pre class="idea-json">${escHtml(ideaRawText || '')}</pre>`;
    return;
  }

  toggle.style.display = '';
  if (ideaViewMode === 'raw') {
    toggle.textContent = 'Show Document View';
    content.innerHTML = `<pre class="idea-json">${escHtml(ideaRawText || '')}</pre>`;
  } else {
    toggle.textContent = 'Show Raw JSON';
    content.innerHTML = `<div class="idea-doc">${ideaPrettyHtml}</div>`;
  }
}

function initPdfJs() {
  if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
  }
}

async function ensurePdfJs() {
  if (window.pdfjsLib && window.pdfjsLib.getDocument) {
    initPdfJs();
    return true;
  }
  if (pdfJsLoadPromise) return pdfJsLoadPromise;

  pdfJsLoadPromise = new Promise(resolve => {
    const script = document.createElement('script');
    script.src = PDFJS_SRC;
    script.async = true;
    script.onload = () => {
      initPdfJs();
      resolve(true);
    };
    script.onerror = () => resolve(false);
    document.head.appendChild(script);
  });

  return pdfJsLoadPromise;
}

async function renderPdfWithPdfJs(url, container) {
  if (!window.pdfjsLib || !window.pdfjsLib.getDocument) return false;

  container.innerHTML = `
    <div class="pdfjs-toolbar">
      <button class="pdf-btn" id="pdf-prev-btn">Prev</button>
      <span class="pdfjs-status" id="pdf-page-status">Loading PDF…</span>
      <button class="pdf-btn" id="pdf-next-btn">Next</button>
      <span class="pdfjs-spacer"></span>
      <a class="pdf-link" href="${encodeURI(url)}" target="_blank" rel="noopener noreferrer">Open PDF in new tab</a>
    </div>
    <div class="pdfjs-canvas-wrap"><canvas class="pdfjs-canvas" id="pdf-preview-canvas"></canvas></div>
  `;

  const prevBtn = container.querySelector('#pdf-prev-btn');
  const nextBtn = container.querySelector('#pdf-next-btn');
  const statusEl = container.querySelector('#pdf-page-status');
  const canvas = container.querySelector('#pdf-preview-canvas');
  const canvasWrap = container.querySelector('.pdfjs-canvas-wrap');
  const ctx = canvas ? canvas.getContext('2d', { alpha: false }) : null;
  if (!prevBtn || !nextBtn || !statusEl || !canvas || !canvasWrap || !ctx) return false;

  const loadingTask = window.pdfjsLib.getDocument({ url });
  const pdfDoc = await loadingTask.promise;
  let pageNum = 1;
  let rendering = false;

  const renderPage = async (targetPage) => {
    if (rendering) return;
    rendering = true;
    try {
      pageNum = Math.max(1, Math.min(targetPage, pdfDoc.numPages));
      statusEl.textContent = `Rendering page ${pageNum}…`;

      const page = await pdfDoc.getPage(pageNum);
      const baseViewport = page.getViewport({ scale: 1.0 });
      const targetWidth = Math.max(320, canvasWrap.clientWidth - 24);
      const scale = Math.max(0.65, Math.min(2.4, targetWidth / Math.max(baseViewport.width, 1)));
      const viewport = page.getViewport({ scale });
      const dpr = window.devicePixelRatio || 1;

      canvas.width = Math.floor(viewport.width * dpr);
      canvas.height = Math.floor(viewport.height * dpr);
      canvas.style.width = `${Math.floor(viewport.width)}px`;
      canvas.style.height = `${Math.floor(viewport.height)}px`;

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      await page.render({ canvasContext: ctx, viewport }).promise;

      statusEl.textContent = `Page ${pageNum} / ${pdfDoc.numPages}`;
      prevBtn.disabled = pageNum <= 1;
      nextBtn.disabled = pageNum >= pdfDoc.numPages;
    } finally {
      rendering = false;
    }
  };

  prevBtn.addEventListener('click', () => {
    if (pageNum > 1) renderPage(pageNum - 1);
  });
  nextBtn.addEventListener('click', () => {
    if (pageNum < pdfDoc.numPages) renderPage(pageNum + 1);
  });

  await renderPage(1);
  return true;
}

function renderPdfFallback(url, container) {
  container.innerHTML = `
    <iframe loading="lazy" src="${encodeURI(url)}#toolbar=0&navpanes=0&statusbar=0"></iframe>
    <div class="pdf-fallback-note">Inline browser preview fallback. If this still downloads, use "Open PDF in new tab".</div>
  `;
}

async function loadIdeaInput() {
  const meta = document.getElementById('idea-meta');
  const content = document.getElementById('idea-content');
  const toggle = document.getElementById('idea-view-toggle');
  if (!meta || !content) return;

  try {
    const resp = await fetch(`/api/jobs/${JOB_ID}/idea`);
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);

    if (!data.found) {
      const stem = data.stem ? ` (stem: ${data.stem})` : '';
      meta.textContent = `No matching idea JSON found${stem}.`;
      content.innerHTML = '<div class="no-data">Could not resolve `idea_<stem>.json` for this job.</div>';
      if (toggle) toggle.style.display = 'none';
      return;
    }

    const formatLabel = data.format === 'json' ? 'JSON' : 'Text';
    meta.textContent = `${formatLabel} source: ${data.source || 'unknown'}`;

    ideaRawText = data.content || '';
    ideaPrettyHtml = '';
    ideaCanToggle = false;
    ideaViewMode = 'pretty';

    if (data.format === 'json') {
      try {
        const parsed = JSON.parse(ideaRawText);
        ideaPrettyHtml = renderIdeaNode(parsed);
        ideaCanToggle = true;
      } catch (_) {
        ideaCanToggle = false;
      }
    }

    updateIdeaView();
  } catch (e) {
    console.error('Failed to load job idea input:', e);
    meta.textContent = 'Failed to load idea input.';
    content.innerHTML = '<div class="no-data">Failed to load idea input.</div>';
    if (toggle) toggle.style.display = 'none';
  }
}

function setActiveTab(tabName) {
  activeTab = tabName;
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tabName);
  });
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.toggle('active', panel.id === `tab-${tabName}`);
  });

  if (tabName === 'submissions' && !submissionsLoaded) {
    loadSubmissions();
  }
}

function renderFilterButtons() {
  const counts = {};
  allEvents.forEach(e => {
    if (e.source === 'agent' || e.source === 'system') {
      counts[e.event_type] = (counts[e.event_type] || 0) + 1;
    }
  });

  const container = document.getElementById('timeline-filters');
  container.innerHTML = '';

  const allBtn = document.createElement('button');
  allBtn.className = 'tf-btn' + (activeFilters.size === 0 ? ' active' : '');
  allBtn.textContent = 'All';
  if (activeFilters.size === 0) {
    allBtn.style.background = 'rgba(53,194,255,0.22)';
    allBtn.style.color = '#fff';
    allBtn.style.borderColor = '#35c2ff';
  }
  allBtn.onclick = () => { activeFilters.clear(); renderFilterButtons(); renderTimeline(); };
  container.appendChild(allBtn);

  Object.entries(EVENT_TYPES).forEach(([type, cfg]) => {
    if (!counts[type]) return;
    const btn = document.createElement('button');
    const isActive = activeFilters.has(type);
    btn.className = 'tf-btn' + (isActive ? ' active' : '');
    if (isActive) {
      btn.style.background = cfg.color + '33';
      btn.style.borderColor = cfg.color;
      btn.style.color = '#fff';
    }
    btn.textContent = `${cfg.label} (${counts[type]})`;
    btn.onclick = () => {
      if (activeFilters.has(type)) activeFilters.delete(type);
      else activeFilters.add(type);
      renderFilterButtons();
      renderTimeline();
    };
    container.appendChild(btn);
  });
}

function createEventEl(ev) {
  const cfg = EVENT_TYPES[ev.event_type] || EVENT_TYPES.other;
  const div = document.createElement('div');
  div.className = `event ev-${ev.event_type}`;
  div.dataset.step = ev.step;

  let tokensHtml = '';
  if (ev.tokens) {
    const total = (ev.tokens.input_tokens || 0) + (ev.tokens.output_tokens || 0);
    if (total > 0) tokensHtml = `<span class="event-tokens">${formatTokens(total)}</span>`;
  }

  div.innerHTML = `
    <div class="event-header">
      <span class="event-step">#${ev.step}</span>
      <span class="event-type-tag" style="background:${cfg.color}2a;color:${cfg.color}">${cfg.label}</span>
      <span class="event-summary" title="${escHtml(ev.summary)}">${escHtml(ev.summary)}</span>
      ${tokensHtml}
    </div>
    ${ev.detail ? `<div class="event-detail">${escHtml(ev.detail)}</div>` : ''}
  `;

  div.addEventListener('click', () => {
    if (selectedEvent && selectedEvent !== div) selectedEvent.classList.remove('selected');
    if (selectedEvent === div) {
      div.classList.remove('selected');
      if (ev.detail) div.classList.remove('expanded');
      selectedEvent = null;
      return;
    }
    div.classList.add('selected');
    if (ev.detail) div.classList.toggle('expanded');
    selectedEvent = div;
  });

  return div;
}

function renderTimeline() {
  const container = document.getElementById('timeline');
  container.innerHTML = '';

  let filtered = allEvents;
  if (activeFilters.size > 0) {
    filtered = allEvents.filter(e => activeFilters.has(e.event_type));
  }

  const toRender = filtered.slice(-450);
  const frag = document.createDocumentFragment();
  toRender.forEach(ev => frag.appendChild(createEventEl(ev)));
  container.appendChild(frag);
}

function appendEvent(ev) {
  allEvents.push(ev);
  if (activeFilters.size > 0 && !activeFilters.has(ev.event_type)) return;

  const container = document.getElementById('timeline');
  const panel = document.getElementById('timeline-panel');
  const wasAtBottom = panel.scrollHeight - panel.scrollTop - panel.clientHeight < 110;

  container.appendChild(createEventEl(ev));
  if (wasAtBottom) panel.scrollTop = panel.scrollHeight;

  while (container.children.length > 550) {
    container.removeChild(container.firstChild);
  }
}

function initTokenChart() {
  const ctx = document.getElementById('token-chart').getContext('2d');
  tokenChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Output', data: [], borderColor: '#4ce0b3', backgroundColor: 'rgba(76,224,179,0.09)', fill: true, tension: 0.28, pointRadius: 0, borderWidth: 2 },
        { label: 'Input', data: [], borderColor: '#35c2ff', backgroundColor: 'rgba(53,194,255,0.10)', fill: true, tension: 0.28, pointRadius: 0, borderWidth: 2 },
        { label: 'Cache Read', data: [], borderColor: '#9e8dff', backgroundColor: 'rgba(158,141,255,0.1)', fill: true, tension: 0.28, pointRadius: 0, borderWidth: 2 },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { position: 'top', labels: { boxWidth: 12, font: { size: 10 }, color: '#9eb3cb' } },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatTokens(ctx.raw)}` } }
      },
      scales: {
        x: { grid: { color: '#1f2d43' }, ticks: { color: '#6f859f', font: { size: 9 }, maxTicksLimit: 8 } },
        y: { grid: { color: '#1f2d43' }, ticks: { color: '#6f859f', font: { size: 9 }, callback: v => formatTokens(v) } }
      }
    }
  });
}

function updateTokenChart(cumulative) {
  if (!tokenChart || !cumulative.length) return;
  tokenChart.data.labels = cumulative.map(c => c.step);
  tokenChart.data.datasets[0].data = cumulative.map(c => c.output_tokens);
  tokenChart.data.datasets[1].data = cumulative.map(c => c.input_tokens);
  tokenChart.data.datasets[2].data = cumulative.map(c => c.cache_read);
  tokenChart.update('none');
}

function initToolChart() {
  const ctx = document.getElementById('tool-chart').getContext('2d');
  toolChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '62%',
      plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 }, color: '#9eb3cb', padding: 6 } } }
    }
  });
}

function updateToolChart(breakdown) {
  if (!toolChart) return;
  if (!breakdown || !breakdown.length) {
    toolChart.data.labels = [];
    toolChart.data.datasets[0].data = [];
    toolChart.update('none');
    document.getElementById('tool-table').innerHTML = '';
    return;
  }
  const colors = ['#35c2ff','#4ce0b3','#9e8dff','#ff6f91','#ffbf69','#5de0ff','#6f859f','#ff9f87','#8ea2b8','#ff7e7e'];
  toolChart.data.labels = breakdown.map(b => b.tool);
  toolChart.data.datasets[0].data = breakdown.map(b => b.count);
  toolChart.data.datasets[0].backgroundColor = breakdown.map((_, i) => colors[i % colors.length]);
  toolChart.update('none');

  document.getElementById('tool-table').innerHTML = breakdown.map(b => `
    <tr>
      <td>${escHtml(b.tool)}</td>
      <td>${b.count}</td>
      <td>${b.pct}%</td>
    </tr>
  `).join('');
}

function initActivityChart() {
  const ctx = document.getElementById('activity-chart').getContext('2d');
  activityChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '62%',
      plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 }, color: '#9eb3cb', padding: 6 } } }
    }
  });
}

function updateActivityChart(breakdown) {
  if (!activityChart) return;
  if (!breakdown || !breakdown.length) {
    activityChart.data.labels = [];
    activityChart.data.datasets[0].data = [];
    activityChart.update('none');
    return;
  }
  activityChart.data.labels = breakdown.map(b => (EVENT_TYPES[b.type] || {}).label || b.type);
  activityChart.data.datasets[0].data = breakdown.map(b => b.count);
  activityChart.data.datasets[0].backgroundColor = breakdown.map(b => (EVENT_TYPES[b.type] || {}).color || '#30363d');
  activityChart.update('none');
}

function renderSubmissionNav() {
  const nav = document.getElementById('submissions-list-nav');
  if (!submissionsCache.length) {
    nav.innerHTML = '<div class="no-data">No submissions yet.</div>';
    return;
  }

  nav.innerHTML = `
    <div class="sub-nav-list">
      ${submissionsCache.map((s, idx) => `
        <button class="sub-nav-item ${idx === selectedSubmissionIdx ? 'active' : ''}" data-sub-idx="${idx}">
          <div class="sub-nav-top">
            <span class="sub-nav-version">v${s.version ?? '?'}</span>
            ${s.reviewer_mode === 'subagent' ? '<span class="sub-mode">subagent</span>' : ''}
          </div>
          <div class="sub-nav-time">${escHtml(formatTimestamp(s.timestamp) || 'Unknown time')}</div>
        </button>
      `).join('')}
    </div>
  `;

  nav.querySelectorAll('[data-sub-idx]').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = Number(btn.dataset.subIdx);
      if (Number.isNaN(idx)) return;
      selectedSubmissionIdx = idx;
      renderSubmissionNav();
      renderSubmissionDetail();
    });
  });
}

function renderSubmissionDetail() {
  const container = document.getElementById('submissions-dossier');
  const meta = document.getElementById('dossier-meta');

  if (selectedSubmissionIdx < 0 || selectedSubmissionIdx >= submissionsCache.length) {
    container.innerHTML = '<div class="no-data">Select a submission from the left.</div>';
    meta.textContent = 'Select a submission version.';
    return;
  }

  const s = submissionsCache[selectedSubmissionIdx];
  const review = renderMarkdown(s.review_markdown || s.review || '');
  const rebuttal = s.rebuttal_markdown || s.rebuttal;
  const rebuttalHtml = rebuttal ? renderMarkdown(rebuttal) : '<p class="md-empty">No rebuttal recorded.</p>';
  meta.textContent = `Version v${s.version ?? '?'} • ${formatTimestamp(s.timestamp) || 'Unknown time'}`;

  container.innerHTML = `
    <article class="submission-entry">
      <div class="entry-header">
        <span class="sub-version">v${s.version ?? '?'}</span>
        <span class="sub-time">${escHtml(formatTimestamp(s.timestamp) || '')}</span>
        ${s.reviewer_mode === 'subagent' ? '<span class="sub-mode">subagent</span>' : ''}
      </div>
      <div class="submission-body">
        <div class="paper-actions">
          ${s.paper_url ? '<button class="pdf-btn" id="preview-pdf-btn">Preview PDF</button>' : ''}
          ${s.paper_url ? `<a class="pdf-link" href="${encodeURI(s.paper_url)}" target="_blank" rel="noopener noreferrer">Open PDF in new tab</a>` : ''}
          ${!s.paper_url ? '<span class="md-empty">No submission PDF captured for this version.</span>' : ''}
        </div>
        <div class="paper-wrap" id="pdf-preview-wrap" style="display:none;"></div>
        <section class="md-section">
          <h4>Review</h4>
          <div class="md-content">${review}</div>
        </section>
        <section class="md-section">
          <h4>Rebuttal</h4>
          <div class="md-content">${rebuttalHtml}</div>
        </section>
        <div class="sub-badges">
          ${s.has_pdf ? '<span class="sub-badge">PDF</span>' : ''}
          ${s.has_tex ? '<span class="sub-badge">TEX</span>' : ''}
          ${s.has_figures ? `<span class="sub-badge">${s.figures_count || 0} figs</span>` : ''}
        </div>
      </div>
    </article>
  `;

  container.querySelectorAll('.md-content a').forEach(a => {
    a.setAttribute('target', '_blank');
    a.setAttribute('rel', 'noopener noreferrer');
  });

  const previewBtn = document.getElementById('preview-pdf-btn');
  const previewWrap = document.getElementById('pdf-preview-wrap');
  if (previewBtn && previewWrap && s.paper_url) {
    const showPreview = async () => {
      if (!previewWrap.dataset.loaded) {
        previewWrap.innerHTML = '<div class="paper-empty">Loading PDF preview…</div>';
        let rendered = false;
        try {
          const pdfReady = await ensurePdfJs();
          if (pdfReady) {
            rendered = await renderPdfWithPdfJs(s.paper_url, previewWrap);
          }
        } catch (e) {
          console.warn('PDF.js preview failed, using iframe fallback:', e);
        }
        if (!rendered) {
          renderPdfFallback(s.paper_url, previewWrap);
        }
        previewWrap.dataset.loaded = '1';
      }
      previewWrap.style.display = '';
      previewBtn.textContent = 'Hide PDF';
    };

    previewBtn.addEventListener('click', async () => {
      const showing = previewWrap.style.display !== 'none';
      if (showing) {
        previewWrap.style.display = 'none';
        previewBtn.textContent = 'Preview PDF';
        return;
      }
      await showPreview();
    });

    void showPreview();
  }
}

async function loadSubmissions(force = false) {
  if (submissionsLoaded && !force) {
    renderSubmissionNav();
    renderSubmissionDetail();
    return;
  }

  try {
    const resp = await fetch(`/api/jobs/${JOB_ID}/submissions`);
    const data = await resp.json();
    const incoming = data.submissions || [];
    const prevSig = submissionsCache.map(s => `${s.directory || ''}:${s.timestamp || ''}`).join('|');
    const nextSig = incoming.map(s => `${s.directory || ''}:${s.timestamp || ''}`).join('|');
    document.getElementById('stat-subs').textContent = data.total || 0;

    if (submissionsLoaded && force && prevSig === nextSig) {
      return;
    }

    submissionsCache = incoming;
    submissionsLoaded = true;

    if (!submissionsCache.length) {
      selectedSubmissionIdx = -1;
    } else if (selectedSubmissionIdx < 0 || selectedSubmissionIdx >= submissionsCache.length) {
      selectedSubmissionIdx = 0;
    }

    renderSubmissionNav();
    renderSubmissionDetail();
  } catch (e) {
    console.error('Failed to load submissions:', e);
    document.getElementById('submissions-list-nav').innerHTML = '<div class="no-data">Failed to load submissions.</div>';
    document.getElementById('submissions-dossier').innerHTML = '<div class="no-data">Failed to load submissions.</div>';
  }
}

async function loadInitialData() {
  try {
    const ideaLoad = loadIdeaInput();
    const [evResp, tokResp, metaResp] = await Promise.all([
      fetch(`/api/jobs/${JOB_ID}/events`),
      fetch(`/api/jobs/${JOB_ID}/tokens`),
      fetch(`/api/jobs/${JOB_ID}/meta`),
    ]);
    const [evData, tokData, metaData] = await Promise.all([
      evResp.json(),
      tokResp.json(),
      metaResp.json(),
    ]);
    allEvents = evData.events || [];
    lastStep = evData.total_lines || 0;

    if (evData.model) document.getElementById('model-badge').textContent = String(evData.model).replace('claude-', '');
    document.getElementById('stat-events').textContent = allEvents.length;

    renderFilterButtons();
    renderTimeline();
    document.getElementById('timeline-panel').scrollTop = document.getElementById('timeline-panel').scrollHeight;

    if (tokData.cost) {
      document.getElementById('stat-tokens').textContent = formatTokens(tokData.cost.total_tokens);
      document.getElementById('stat-cost').textContent = '$' + (tokData.cost.estimated_cost_usd || 0).toFixed(2);
    }
    updateTokenChart(tokData.cumulative_tokens || []);
    updateToolChart(tokData.tool_breakdown || []);
    updateActivityChart(tokData.event_type_breakdown || []);

    if (metaResp.ok && !metaData.error) {
      const badge = document.getElementById('status-badge');
      badge.textContent = metaData.status;
      badge.className = 'status-badge ' + metaData.status;
      if (metaData.model) {
        document.getElementById('model-badge').textContent = String(metaData.model).replace('claude-', '');
      }
      isLive = metaData.status === 'running';
      document.getElementById('stat-subs').textContent = metaData.submissions || 0;
      if (metaData.gitlab_url) {
        const glLink = document.getElementById('gitlab-link');
        glLink.href = metaData.gitlab_url;
        glLink.style.display = 'inline-block';
      }
    } else {
      document.getElementById('status-badge').className = 'status-badge unknown';
      document.getElementById('status-badge').textContent = 'unknown';
    }

    await ideaLoad;
    if (activeTab === 'submissions') {
      await loadSubmissions();
    }
    if (isLive) startSSE();
  } catch (e) {
    console.error('Failed to load job data:', e);
  }
}

function startSSE() {
  if (evtSource) evtSource.close();

  evtSource = new EventSource(`/api/jobs/${JOB_ID}/stream?after=${lastStep}`);

  evtSource.addEventListener('new_event', (e) => {
    const event = JSON.parse(e.data);
    appendEvent(event);
    lastStep = Math.max(lastStep, (event.line_num || 0) + 1);
    document.getElementById('stat-events').textContent = allEvents.length;
    renderFilterButtons();
  });

  evtSource.addEventListener('metrics', (e) => {
    const m = JSON.parse(e.data);
    if (m.cost) {
      document.getElementById('stat-tokens').textContent = formatTokens(m.cost.total_tokens);
      document.getElementById('stat-cost').textContent = '$' + (m.cost.estimated_cost_usd || 0).toFixed(2);
    }
    updateToolChart(m.tool_breakdown || []);
    updateActivityChart(m.event_type_breakdown || []);
    if (typeof m.total_lines === 'number') lastStep = Math.max(lastStep, m.total_lines);
  });

  evtSource.onerror = () => {
    setTimeout(() => { if (isLive) startSSE(); }, 5000);
  };

  if (tokenRefreshTimer) clearInterval(tokenRefreshTimer);
  tokenRefreshTimer = setInterval(async () => {
    if (!isLive) return;
    try {
      const tokResp = await fetch(`/api/jobs/${JOB_ID}/tokens`);
      const tokData = await tokResp.json();
      updateTokenChart(tokData.cumulative_tokens || []);
      if (activeTab === 'submissions') {
        await loadSubmissions(true);
      }
    } catch (_) {}
  }, 12000);
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
  });
  const ideaToggle = document.getElementById('idea-view-toggle');
  if (ideaToggle) {
    ideaToggle.addEventListener('click', () => {
      if (!ideaCanToggle) return;
      ideaViewMode = ideaViewMode === 'raw' ? 'pretty' : 'raw';
      updateIdeaView();
    });
  }

  initTokenChart();
  initToolChart();
  initActivityChart();
  loadInitialData();
});
</script>
</body>
</html>
