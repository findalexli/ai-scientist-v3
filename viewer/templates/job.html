<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Job Detail — AI Scientist v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<style>
:root {
  --bg0: #060a10;
  --bg1: #0c1219;
  --bg2: #0f1a28;
  --surface: #111c2b;
  --surface2: #182838;
  --surface3: #1f3248;
  --border: #1c2e44;
  --border-hover: #2c4a6a;
  --text: #e2ecf6;
  --text-dim: #6e88a6;
  --text-muted: #3e5670;
  --accent: #5cb8ff;
  --accent-glow: rgba(92,184,255,0.15);
  --accent-2: #3dd9a4;
  --accent2-glow: rgba(61,217,164,0.12);
  --warm: #ffaa44;
  --danger: #ff6670;
  --purple: #a07cff;
  --pink: #ff6a96;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Outfit', sans-serif;
  color: var(--text);
  background: var(--bg0);
  min-height: 100vh;
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Layered background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 1400px 600px at 10% -8%, rgba(92,184,255,0.10), transparent 65%),
    radial-gradient(ellipse 1000px 500px at 90% -5%, rgba(61,217,164,0.07), transparent 60%),
    radial-gradient(ellipse 600px 400px at 50% 100%, rgba(160,124,255,0.05), transparent 60%);
  pointer-events: none;
  z-index: 0;
}

/* Noise grain overlay */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  opacity: 0.028;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  background-size: 256px 256px;
  pointer-events: none;
  z-index: 9998;
}

.page {
  position: relative;
  z-index: 1;
  max-width: 1560px;
  margin: 0 auto;
  padding: 20px 24px 40px;
}

/* ─── Header ─── */
.header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 20px;
  border: 1px solid var(--border);
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(17,28,43,0.92), rgba(12,18,25,0.82));
  backdrop-filter: blur(12px);
  box-shadow:
    0 1px 0 0 rgba(255,255,255,0.03) inset,
    0 16px 48px rgba(0,0,0,0.4);
}

.header a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
  font-size: 13px;
  transition: opacity 0.15s ease;
}

.header a:hover { opacity: 0.8; }

.header h1 {
  font-size: 17px;
  font-weight: 700;
  letter-spacing: -0.01em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 400px;
}

.header-stats {
  margin-left: auto;
  display: flex;
  gap: 24px;
  align-items: center;
}

.stat {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  text-transform: uppercase;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.1em;
  color: var(--text-muted);
}

.stat .val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -0.03em;
  color: var(--text);
  line-height: 1.1;
}

.stat .val.cost { color: var(--warm); }

.status-badge, .model-badge {
  border-radius: 6px;
  padding: 4px 10px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  white-space: nowrap;
}

.status-badge.running { color: #66f0a2; background: rgba(76,224,179,0.15); }
.status-badge.completed { color: #8aa6c2; background: rgba(138,166,194,0.12); }
.status-badge.idle { color: var(--warm); background: rgba(255,170,68,0.12); }
.status-badge.unknown { color: var(--text-dim); background: rgba(110,136,166,0.1); }
.model-badge { background: var(--accent-glow); color: var(--accent); }

/* ─── Tabs ─── */
.tab-switcher {
  margin-top: 14px;
  display: flex;
  gap: 6px;
}

.tab-btn {
  border: 1px solid var(--border);
  background: rgba(24,40,56,0.5);
  color: var(--text-dim);
  font-family: 'Outfit', sans-serif;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.tab-btn:hover {
  border-color: var(--border-hover);
  color: var(--text);
}

.tab-btn.active {
  background: var(--accent-glow);
  color: var(--text);
  border-color: rgba(92,184,255,0.4);
}

.tab-panel {
  margin-top: 14px;
  display: none;
  animation: fadeIn 0.2s ease;
}

.tab-panel.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ─── Idea Card ─── */
.idea-card {
  margin-bottom: 14px;
  overflow: hidden;
}

.idea-head {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
}

.idea-meta {
  margin-top: 3px;
  color: var(--text-dim);
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  word-break: break-word;
}

.idea-content {
  max-height: 300px;
  overflow: auto;
  padding: 12px 14px;
  background: rgba(6,10,16,0.5);
}

.idea-json {
  margin: 0;
  color: #c8d8ec;
  font-size: 12px;
  line-height: 1.55;
  font-family: 'JetBrains Mono', monospace;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
}

.idea-doc { display: grid; gap: 10px; }

.idea-field {
  border: 1px solid rgba(28,46,68,0.7);
  border-radius: 8px;
  background: rgba(15,26,40,0.5);
  overflow: hidden;
}

.idea-key {
  font-size: 10px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--accent-2);
  padding: 7px 10px;
  border-bottom: 1px solid rgba(28,46,68,0.6);
  background: rgba(17,28,43,0.7);
}

.idea-val { padding: 8px 10px; }
.idea-obj { display: grid; gap: 8px; }
.idea-array { display: grid; gap: 8px; }

.idea-arr-item {
  border: 1px solid rgba(28,46,68,0.5);
  border-radius: 7px;
  padding: 7px 8px;
  background: rgba(10,18,28,0.4);
}

.idea-arr-label {
  font-size: 9px;
  color: var(--text-muted);
  letter-spacing: 0.06em;
  text-transform: uppercase;
  margin-bottom: 4px;
  font-weight: 600;
}

.idea-str {
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  font-size: 13px;
  color: var(--text);
  line-height: 1.5;
}

.idea-primitive {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: #c8d8ec;
}

.idea-empty {
  font-size: 12px;
  color: var(--text-dim);
  font-style: italic;
}

/* ─── Main Layout (Trajectory) ─── */
.main {
  display: grid;
  grid-template-columns: minmax(0, 1fr) 380px;
  gap: 14px;
  align-items: start;
}

.card {
  border: 1px solid var(--border);
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(17,28,43,0.88), rgba(12,18,25,0.72));
  box-shadow:
    0 1px 0 0 rgba(255,255,255,0.02) inset,
    0 10px 32px rgba(0,0,0,0.3);
}

/* ─── Timeline ─── */
.timeline-card { min-height: 72vh; }

.timeline-top {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
}

.timeline-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.tf-btn {
  border: 1px solid var(--border);
  background: rgba(24,40,56,0.5);
  color: var(--text-dim);
  font-family: 'Outfit', sans-serif;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.02em;
  border-radius: 6px;
  padding: 4px 10px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.tf-btn:hover { border-color: var(--border-hover); color: var(--text); }
.tf-btn.active { box-shadow: 0 0 0 1px rgba(255,255,255,0.04) inset; }

.timeline-panel {
  max-height: 72vh;
  overflow: auto;
  padding: 10px 12px;
}

/* ─── Events ─── */
.event {
  border: 1px solid rgba(28,46,68,0.5);
  border-left: 3px solid var(--border);
  border-radius: 10px;
  background: rgba(17,28,43,0.7);
  padding: 9px 11px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: all 0.12s ease;
}

.event:hover {
  background: rgba(24,40,60,0.85);
  border-color: rgba(28,46,68,0.7);
}

.event.selected {
  border-color: rgba(92,184,255,0.5);
  box-shadow: 0 0 0 1px rgba(92,184,255,0.15) inset;
  background: rgba(28,46,68,0.5);
}

.event-header {
  display: flex;
  align-items: center;
  gap: 8px;
}

.event-step {
  min-width: 36px;
  font-size: 10px;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
}

.event-type-tag {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  border-radius: 5px;
  padding: 2px 7px;
}

.event-summary {
  font-size: 12.5px;
  color: var(--text);
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-weight: 500;
}

.event-tokens {
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 500;
  white-space: nowrap;
}

.event-detail {
  margin-top: 8px;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid rgba(28,46,68,0.5);
  background: rgba(6,10,16,0.55);
  color: #a8c0d8;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  white-space: pre-wrap;
  word-break: break-word;
  display: none;
  max-height: 280px;
  overflow: auto;
  line-height: 1.5;
}

.event.expanded .event-detail { display: block; animation: slideDown 0.15s ease; }

@keyframes slideDown {
  from { opacity: 0; max-height: 0; }
  to { opacity: 1; max-height: 280px; }
}

/* Event type left border colors */
.ev-literature_review { border-left-color: #a07cff !important; }
.ev-submission { border-left-color: #ff6a96 !important; }
.ev-experiment { border-left-color: #3dd9a4 !important; }
.ev-paper_write { border-left-color: #5cb8ff !important; }
.ev-plotting { border-left-color: #60e6ff !important; }
.ev-git_clone, .ev-pip_install { border-left-color: #ffaa44 !important; }
.ev-bash, .ev-file_read, .ev-file_write, .ev-text, .ev-thinking, .ev-task_mgmt { border-left-color: #5a7490 !important; }
.ev-web, .ev-user_message { border-left-color: var(--warm) !important; }
.ev-tool_result { border-left-color: #3a5a78 !important; }
.ev-system { border-left-color: var(--accent) !important; }
.ev-subagent { border-left-color: #ff9a80 !important; }

/* ─── Side Panels ─── */
.side {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.panel { padding: 14px; }

.panel-title {
  font-size: 10px;
  font-weight: 800;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 10px;
}

.chart-container { position: relative; height: 190px; }
.donut-container { position: relative; height: 170px; }

.tool-table { width: 100%; font-size: 12px; border-spacing: 0; }
.tool-table td { padding: 3px 4px; }
.tool-table td:nth-child(2), .tool-table td:nth-child(3) {
  text-align: right;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
}

/* ─── Submissions Layout ─── */
.submissions-layout {
  display: grid;
  grid-template-columns: 300px minmax(0, 1fr);
  gap: 14px;
  align-items: start;
}

.submissions-nav {
  padding: 14px;
  max-height: 76vh;
  overflow: auto;
}

.sub-nav-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.sub-nav-item {
  border: 1px solid var(--border);
  border-radius: 10px;
  background: rgba(15,26,40,0.6);
  color: var(--text);
  width: 100%;
  text-align: left;
  padding: 10px 12px;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  transition: all 0.15s ease;
}

.sub-nav-item:hover {
  border-color: var(--border-hover);
  background: rgba(24,40,56,0.5);
}

.sub-nav-item.active {
  border-color: rgba(92,184,255,0.4);
  box-shadow: 0 0 0 1px rgba(92,184,255,0.12) inset;
  background: rgba(28,46,68,0.5);
}

.sub-nav-top {
  display: flex;
  align-items: center;
  gap: 8px;
}

.sub-nav-version {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.04em;
  color: var(--accent-2);
}

.sub-nav-time {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 3px;
}

/* ─── Submission Dossier ─── */
.submission-dossier {
  padding: 16px;
  min-height: 76vh;
}

.dossier-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.dossier-title {
  font-family: 'Crimson Pro', serif;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.01em;
}

.dossier-title-sub {
  font-size: 11px;
  color: var(--text-dim);
  letter-spacing: 0.04em;
  text-transform: uppercase;
  margin-top: 2px;
}

.submission-entry {
  border: 1px solid var(--border);
  border-radius: 12px;
  background: rgba(15,26,40,0.5);
  overflow: hidden;
}

.entry-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  background: rgba(24,40,56,0.4);
}

.sub-version {
  background: var(--accent2-glow);
  color: var(--accent-2);
  font-size: 11px;
  font-weight: 700;
  border-radius: 6px;
  padding: 3px 10px;
  letter-spacing: 0.02em;
}

.sub-time {
  font-size: 12px;
  color: var(--text-dim);
}

.sub-mode {
  margin-left: auto;
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 5px;
  background: var(--accent-glow);
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-weight: 600;
}

.submission-body {
  padding: 14px;
  display: grid;
  gap: 14px;
}

.paper-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.pdf-btn {
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--accent-glow);
  color: var(--accent);
  font-family: 'Outfit', sans-serif;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 7px 12px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.pdf-btn:hover {
  border-color: var(--accent);
  background: rgba(92,184,255,0.22);
}

.pdf-link {
  color: var(--accent);
  text-decoration: none;
  font-size: 12px;
  font-weight: 600;
  transition: opacity 0.15s ease;
}

.pdf-link:hover { opacity: 0.8; }

.paper-wrap {
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  background: rgba(6,10,16,0.5);
}

.paper-wrap iframe {
  border: 0;
  width: 100%;
  min-height: 440px;
  background: #fff;
}

.paper-empty {
  padding: 20px;
  color: var(--text-dim);
  font-size: 12px;
}

.pdfjs-toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  background: rgba(17,28,43,0.75);
}

.pdfjs-status {
  color: var(--text-dim);
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
}

.pdfjs-spacer { flex: 1; }

.pdfjs-canvas-wrap {
  padding: 12px;
  display: flex;
  justify-content: center;
  overflow: auto;
  background: rgba(6,10,16,0.3);
}

.pdfjs-canvas {
  max-width: 100%;
  height: auto;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  background: #fff;
  border-radius: 2px;
}

.pdf-fallback-note {
  padding: 8px 12px;
  border-top: 1px solid var(--border);
  color: var(--text-muted);
  font-size: 11px;
}

/* ─── Markdown Sections ─── */
.md-section {
  border: 1px solid var(--border);
  border-radius: 10px;
  background: rgba(6,10,16,0.4);
  padding: 14px;
}

.md-section h4 {
  font-size: 10px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  margin-bottom: 10px;
}

.md-content {
  font-size: 13px;
  color: var(--text);
  line-height: 1.6;
}

.md-content p { margin: 0 0 8px; }
.md-content p:last-child { margin-bottom: 0; }

.md-content pre {
  background: rgba(6,10,16,0.7);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  overflow: auto;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  line-height: 1.5;
}

.md-content code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  background: rgba(28,46,68,0.4);
  padding: 1px 5px;
  border-radius: 4px;
}

.md-content pre code {
  background: none;
  padding: 0;
  border-radius: 0;
}

.md-content a {
  color: var(--accent);
  text-decoration: none;
}

.md-content a:hover { text-decoration: underline; }

.md-content ul, .md-content ol {
  margin: 0 0 8px 20px;
}

.md-content h1, .md-content h2, .md-content h3, .md-content h4, .md-content h5 {
  margin: 16px 0 8px;
  color: var(--text);
  font-weight: 700;
}

.md-content h1 { font-size: 18px; }
.md-content h2 { font-size: 16px; }
.md-content h3 { font-size: 14px; }

.md-content blockquote {
  border-left: 3px solid var(--accent);
  padding-left: 12px;
  margin: 8px 0;
  color: var(--text-dim);
}

.md-content table {
  border-collapse: collapse;
  width: 100%;
  margin: 8px 0;
  font-size: 12px;
}

.md-content table th, .md-content table td {
  border: 1px solid var(--border);
  padding: 6px 10px;
  text-align: left;
}

.md-content table th {
  background: rgba(24,40,56,0.4);
  font-weight: 700;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-dim);
}

.md-empty {
  color: var(--text-dim);
  font-size: 12px;
  font-style: italic;
}

.sub-badges { display: flex; gap: 6px; flex-wrap: wrap; }

.sub-badge {
  font-size: 10px;
  border-radius: 5px;
  padding: 2px 8px;
  border: 1px solid var(--border);
  color: var(--text-dim);
  font-weight: 600;
}

.no-data {
  padding: 24px;
  text-align: center;
  color: var(--text-dim);
  font-size: 13px;
}

.help-strip {
  margin-top: 10px;
  padding: 8px 14px;
  border: 1px solid rgba(28,46,68,0.4);
  border-radius: 8px;
  color: var(--text-muted);
  font-size: 11px;
  background: rgba(17,28,43,0.3);
}

/* ─── Scrollbar ─── */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(56,84,112,0.5); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(56,84,112,0.8); }

/* ─── Focus / Selection ─── */
:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

::selection {
  background: rgba(92,184,255,0.25);
  color: var(--text);
}

/* ─── Responsive ─── */
@media (max-width: 1100px) {
  .submissions-layout { grid-template-columns: 1fr; }
  .submissions-nav { max-height: none; }
  .main { grid-template-columns: 1fr; }
  .timeline-card { min-height: 54vh; }
  .timeline-panel { max-height: 54vh; }
}

@media (max-width: 760px) {
  .header {
    flex-wrap: wrap;
    gap: 10px;
    padding: 14px;
  }
  .header h1 { max-width: 100%; }
  .header-stats {
    margin-left: 0;
    width: 100%;
    justify-content: space-between;
  }
  .stat { align-items: flex-start; }
  .stat .val { font-size: 16px; }
  .paper-wrap iframe { min-height: 340px; }
  .page { padding: 14px 10px 24px; }
}
</style>
</head>
<body>
<div class="page">
  <div class="header">
    <a href="/">&larr; All Jobs</a>
    <h1 id="job-title">{{JOB_ID}}</h1>
    <span class="status-badge" id="status-badge">...</span>
    <span class="model-badge" id="model-badge">...</span>
    <a id="gitlab-link" href="#" target="_blank" rel="noopener" style="display:none; margin-left:8px; font-size:11px; color:#fc6d26; text-decoration:none; border:1px solid rgba(252,109,38,0.25); border-radius:6px; padding:4px 10px; font-weight:600; letter-spacing:0.04em;">GitLab</a>
    <div class="header-stats">
      <div class="stat"><span class="val" id="stat-events">-</span>events</div>
      <div class="stat"><span class="val" id="stat-tokens">-</span>tokens</div>
      <div class="stat"><span class="val cost" id="stat-cost">-</span>est. cost</div>
      <div class="stat"><span class="val" id="stat-subs">-</span>submissions</div>
    </div>
  </div>

  <div class="tab-switcher">
    <button class="tab-btn active" data-tab="submissions">Submissions</button>
    <button class="tab-btn" data-tab="trajectory">Trajectory</button>
  </div>
  <div class="help-strip">Submission: a saved paper version with review and rebuttal. Trajectory: chronological agent actions.</div>

  <div class="tab-panel" id="tab-trajectory">
    <div class="card idea-card">
      <div class="idea-head">
        <div>
          <div class="panel-title">Model Input — Original Idea</div>
          <div class="idea-meta" id="idea-meta">Resolving idea source...</div>
        </div>
        <button class="pdf-btn" id="idea-view-toggle" style="display:none;">Show Raw JSON</button>
      </div>
      <div class="idea-content" id="idea-content">
        <div class="no-data">Loading idea input...</div>
      </div>
    </div>

    <div class="main">
      <div class="card timeline-card">
        <div class="timeline-top">
          <div class="timeline-filters" id="timeline-filters"></div>
        </div>
        <div class="timeline-panel" id="timeline-panel">
          <div id="timeline"></div>
        </div>
      </div>

      <div class="side">
        <div class="card panel">
          <div class="panel-title">Cumulative Token Usage</div>
          <div class="chart-container"><canvas id="token-chart"></canvas></div>
        </div>

        <div class="card panel">
          <div class="panel-title">Tool Breakdown</div>
          <div class="donut-container"><canvas id="tool-chart"></canvas></div>
          <table class="tool-table" id="tool-table"></table>
        </div>

        <div class="card panel">
          <div class="panel-title">Activity Breakdown</div>
          <div class="donut-container"><canvas id="activity-chart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-panel active" id="tab-submissions">
    <div class="submissions-layout">
      <div class="card submissions-nav">
        <div class="panel-title">Submission Versions</div>
        <div id="submissions-list-nav"><div class="no-data">Loading submissions...</div></div>
      </div>
      <div class="card submission-dossier">
        <div class="dossier-head">
          <div>
            <div class="dossier-title">Submission Dossier</div>
            <div class="dossier-title-sub" id="dossier-meta">Select a submission version.</div>
          </div>
        </div>
        <div id="submissions-dossier"><div class="no-data">Select a submission from the left.</div></div>
      </div>
    </div>
  </div>
</div>

<script>
const JOB_ID = '{{JOB_ID}}';
let allEvents = [];
let lastStep = 0;
let activeFilters = new Set();
let tokenChart = null;
let toolChart = null;
let activityChart = null;
let isLive = false;
let evtSource = null;
let selectedEvent = null;
let tokenRefreshTimer = null;
let submissionsCache = [];
let submissionsLoaded = false;
let selectedSubmissionIdx = -1;
let activeTab = 'submissions';
let ideaRawText = '';
let ideaPrettyHtml = '';
let ideaCanToggle = false;
let ideaViewMode = 'pretty';
let pdfJsLoadPromise = null;

const PDFJS_SRC = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';

const EVENT_TYPES = {
  literature_review: { label: 'Literature', color: '#a07cff' },
  submission: { label: 'Submission', color: '#ff6a96' },
  experiment: { label: 'Experiment', color: '#3dd9a4' },
  paper_write: { label: 'Paper', color: '#5cb8ff' },
  plotting: { label: 'Plotting', color: '#60e6ff' },
  git_clone: { label: 'Git', color: '#ffaa44' },
  pip_install: { label: 'Install', color: '#ffaa44' },
  bash: { label: 'Bash', color: '#5a7490' },
  web: { label: 'Web', color: '#ffaa44' },
  file_read: { label: 'Read', color: '#5a7490' },
  file_write: { label: 'Write', color: '#5a7490' },
  subagent: { label: 'Subagent', color: '#ff9a80' },
  thinking: { label: 'Thinking', color: '#5a7490' },
  text: { label: 'Text', color: '#5a7490' },
  tool_result: { label: 'Result', color: '#3a5a78' },
  task_mgmt: { label: 'TaskMgmt', color: '#5a7490' },
  system: { label: 'System', color: '#5cb8ff' },
  user_message: { label: 'User', color: '#ffaa44' },
  other: { label: 'Other', color: '#2a3a4e' },
};

function formatTokens(n) {
  if (!n) return '-';
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1_000) return (n / 1_000).toFixed(0) + 'K';
  return String(n);
}

function formatTimestamp(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return ts;
  return d.toLocaleString();
}

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderMarkdown(text) {
  if (!text || !text.trim()) return '<p class="md-empty">No content provided.</p>';
  let html = '';
  if (window.marked) {
    html = marked.parse(text, { breaks: true, gfm: true, mangle: false, headerIds: false });
  } else {
    html = escHtml(text).replace(/\n/g, '<br>');
  }
  if (window.DOMPurify) {
    html = DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
  }
  return html;
}

function renderIdeaNode(value, depth = 0) {
  if (value === null) return '<div class="idea-empty">null</div>';

  const t = typeof value;
  if (t === 'string') {
    return `<div class="idea-str">${escHtml(value)}</div>`;
  }
  if (t === 'number' || t === 'boolean') {
    return `<div class="idea-primitive">${escHtml(String(value))}</div>`;
  }
  if (Array.isArray(value)) {
    if (!value.length) return '<div class="idea-empty">[]</div>';
    return `
      <div class="idea-array">
        ${value.map((item, idx) => `
          <div class="idea-arr-item">
            <div class="idea-arr-label">Item ${idx + 1}</div>
            ${renderIdeaNode(item, depth + 1)}
          </div>
        `).join('')}
      </div>
    `;
  }
  if (t === 'object') {
    const entries = Object.entries(value);
    if (!entries.length) return '<div class="idea-empty">{}</div>';
    return `
      <div class="idea-obj">
        ${entries.map(([k, v]) => `
          <div class="idea-field">
            <div class="idea-key">${escHtml(k)}</div>
            <div class="idea-val">${renderIdeaNode(v, depth + 1)}</div>
          </div>
        `).join('')}
      </div>
    `;
  }
  return `<div class="idea-primitive">${escHtml(String(value))}</div>`;
}

function updateIdeaView() {
  const content = document.getElementById('idea-content');
  const toggle = document.getElementById('idea-view-toggle');
  if (!content || !toggle) return;

  if (!ideaCanToggle) {
    toggle.style.display = 'none';
    content.innerHTML = `<pre class="idea-json">${escHtml(ideaRawText || '')}</pre>`;
    return;
  }

  toggle.style.display = '';
  if (ideaViewMode === 'raw') {
    toggle.textContent = 'Show Document View';
    content.innerHTML = `<pre class="idea-json">${escHtml(ideaRawText || '')}</pre>`;
  } else {
    toggle.textContent = 'Show Raw JSON';
    content.innerHTML = `<div class="idea-doc">${ideaPrettyHtml}</div>`;
  }
}

function initPdfJs() {
  if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
  }
}

async function ensurePdfJs() {
  if (window.pdfjsLib && window.pdfjsLib.getDocument) {
    initPdfJs();
    return true;
  }
  if (pdfJsLoadPromise) return pdfJsLoadPromise;

  pdfJsLoadPromise = new Promise(resolve => {
    const script = document.createElement('script');
    script.src = PDFJS_SRC;
    script.async = true;
    script.onload = () => {
      initPdfJs();
      resolve(true);
    };
    script.onerror = () => resolve(false);
    document.head.appendChild(script);
  });

  return pdfJsLoadPromise;
}

async function renderPdfWithPdfJs(url, container) {
  if (!window.pdfjsLib || !window.pdfjsLib.getDocument) return false;

  container.innerHTML = `
    <div class="pdfjs-toolbar">
      <button class="pdf-btn" id="pdf-prev-btn">Prev</button>
      <span class="pdfjs-status" id="pdf-page-status">Loading PDF...</span>
      <button class="pdf-btn" id="pdf-next-btn">Next</button>
      <span class="pdfjs-spacer"></span>
      <a class="pdf-link" href="${encodeURI(url)}" target="_blank" rel="noopener noreferrer">Open in new tab</a>
    </div>
    <div class="pdfjs-canvas-wrap"><canvas class="pdfjs-canvas" id="pdf-preview-canvas"></canvas></div>
  `;

  const prevBtn = container.querySelector('#pdf-prev-btn');
  const nextBtn = container.querySelector('#pdf-next-btn');
  const statusEl = container.querySelector('#pdf-page-status');
  const canvas = container.querySelector('#pdf-preview-canvas');
  const canvasWrap = container.querySelector('.pdfjs-canvas-wrap');
  const ctx = canvas ? canvas.getContext('2d', { alpha: false }) : null;
  if (!prevBtn || !nextBtn || !statusEl || !canvas || !canvasWrap || !ctx) return false;

  const loadingTask = window.pdfjsLib.getDocument({ url });
  const pdfDoc = await loadingTask.promise;
  let pageNum = 1;
  let rendering = false;

  const renderPage = async (targetPage) => {
    if (rendering) return;
    rendering = true;
    try {
      pageNum = Math.max(1, Math.min(targetPage, pdfDoc.numPages));
      statusEl.textContent = `Rendering page ${pageNum}...`;

      const page = await pdfDoc.getPage(pageNum);
      const baseViewport = page.getViewport({ scale: 1.0 });
      const targetWidth = Math.max(320, canvasWrap.clientWidth - 24);
      const scale = Math.max(0.65, Math.min(2.4, targetWidth / Math.max(baseViewport.width, 1)));
      const viewport = page.getViewport({ scale });
      const dpr = window.devicePixelRatio || 1;

      canvas.width = Math.floor(viewport.width * dpr);
      canvas.height = Math.floor(viewport.height * dpr);
      canvas.style.width = `${Math.floor(viewport.width)}px`;
      canvas.style.height = `${Math.floor(viewport.height)}px`;

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      await page.render({ canvasContext: ctx, viewport }).promise;

      statusEl.textContent = `Page ${pageNum} / ${pdfDoc.numPages}`;
      prevBtn.disabled = pageNum <= 1;
      nextBtn.disabled = pageNum >= pdfDoc.numPages;
    } finally {
      rendering = false;
    }
  };

  prevBtn.addEventListener('click', () => {
    if (pageNum > 1) renderPage(pageNum - 1);
  });
  nextBtn.addEventListener('click', () => {
    if (pageNum < pdfDoc.numPages) renderPage(pageNum + 1);
  });

  await renderPage(1);
  return true;
}

function renderPdfFallback(url, container) {
  container.innerHTML = `
    <iframe loading="lazy" src="${encodeURI(url)}#toolbar=0&navpanes=0&statusbar=0"></iframe>
    <div class="pdf-fallback-note">Inline browser preview fallback. If this still downloads, use "Open in new tab".</div>
  `;
}

async function loadIdeaInput() {
  const meta = document.getElementById('idea-meta');
  const content = document.getElementById('idea-content');
  const toggle = document.getElementById('idea-view-toggle');
  if (!meta || !content) return;

  try {
    const resp = await fetch(`/api/jobs/${JOB_ID}/idea`);
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);

    if (!data.found) {
      const stem = data.stem ? ` (stem: ${data.stem})` : '';
      meta.textContent = `No matching idea JSON found${stem}.`;
      content.innerHTML = '<div class="no-data">Could not resolve idea JSON for this job.</div>';
      if (toggle) toggle.style.display = 'none';
      return;
    }

    const formatLabel = data.format === 'json' ? 'JSON' : 'Text';
    meta.textContent = `${formatLabel} source: ${data.source || 'unknown'}`;

    ideaRawText = data.content || '';
    ideaPrettyHtml = '';
    ideaCanToggle = false;
    ideaViewMode = 'pretty';

    if (data.format === 'json') {
      try {
        const parsed = JSON.parse(ideaRawText);
        ideaPrettyHtml = renderIdeaNode(parsed);
        ideaCanToggle = true;
      } catch (_) {
        ideaCanToggle = false;
      }
    }

    updateIdeaView();
  } catch (e) {
    console.error('Failed to load job idea input:', e);
    meta.textContent = 'Failed to load idea input.';
    content.innerHTML = '<div class="no-data">Failed to load idea input.</div>';
    if (toggle) toggle.style.display = 'none';
  }
}

function setActiveTab(tabName) {
  activeTab = tabName;
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tabName);
  });
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.toggle('active', panel.id === `tab-${tabName}`);
  });

  if (tabName === 'submissions' && !submissionsLoaded) {
    loadSubmissions();
  }
}

function renderFilterButtons() {
  const counts = {};
  allEvents.forEach(e => {
    if (e.source === 'agent' || e.source === 'system') {
      counts[e.event_type] = (counts[e.event_type] || 0) + 1;
    }
  });

  const container = document.getElementById('timeline-filters');
  container.innerHTML = '';

  const allBtn = document.createElement('button');
  allBtn.className = 'tf-btn' + (activeFilters.size === 0 ? ' active' : '');
  allBtn.textContent = 'All';
  if (activeFilters.size === 0) {
    allBtn.style.background = 'rgba(92,184,255,0.15)';
    allBtn.style.color = '#fff';
    allBtn.style.borderColor = 'rgba(92,184,255,0.4)';
  }
  allBtn.onclick = () => { activeFilters.clear(); renderFilterButtons(); renderTimeline(); };
  container.appendChild(allBtn);

  Object.entries(EVENT_TYPES).forEach(([type, cfg]) => {
    if (!counts[type]) return;
    const btn = document.createElement('button');
    const isActive = activeFilters.has(type);
    btn.className = 'tf-btn' + (isActive ? ' active' : '');
    if (isActive) {
      btn.style.background = cfg.color + '22';
      btn.style.borderColor = cfg.color + '66';
      btn.style.color = '#fff';
    }
    btn.textContent = `${cfg.label} (${counts[type]})`;
    btn.onclick = () => {
      if (activeFilters.has(type)) activeFilters.delete(type);
      else activeFilters.add(type);
      renderFilterButtons();
      renderTimeline();
    };
    container.appendChild(btn);
  });
}

function createEventEl(ev) {
  const cfg = EVENT_TYPES[ev.event_type] || EVENT_TYPES.other;
  const div = document.createElement('div');
  div.className = `event ev-${ev.event_type}`;
  div.dataset.step = ev.step;

  let tokensHtml = '';
  if (ev.tokens) {
    const total = (ev.tokens.input_tokens || 0) + (ev.tokens.output_tokens || 0);
    if (total > 0) tokensHtml = `<span class="event-tokens">${formatTokens(total)}</span>`;
  }

  div.innerHTML = `
    <div class="event-header">
      <span class="event-step">#${ev.step}</span>
      <span class="event-type-tag" style="background:${cfg.color}1a;color:${cfg.color}">${cfg.label}</span>
      <span class="event-summary" title="${escHtml(ev.summary)}">${escHtml(ev.summary)}</span>
      ${tokensHtml}
    </div>
  `;

  div.addEventListener('click', () => {
    if (selectedEvent && selectedEvent !== div) {
      selectedEvent.classList.remove('selected');
      selectedEvent.classList.remove('expanded');
    }
    if (selectedEvent === div) {
      div.classList.remove('selected');
      div.classList.remove('expanded');
      selectedEvent = null;
      return;
    }
    div.classList.add('selected');
    if (ev.detail && !div.querySelector('.event-detail')) {
      const detailEl = document.createElement('div');
      detailEl.className = 'event-detail';
      detailEl.textContent = ev.detail;
      div.appendChild(detailEl);
    }
    if (ev.detail) div.classList.add('expanded');
    selectedEvent = div;
  });

  return div;
}

function renderTimeline() {
  const container = document.getElementById('timeline');
  container.innerHTML = '';

  let filtered = allEvents;
  if (activeFilters.size > 0) {
    filtered = allEvents.filter(e => activeFilters.has(e.event_type));
  }

  const MAX_INITIAL = 2000;
  const toRender = filtered.length > MAX_INITIAL ? filtered.slice(-MAX_INITIAL) : filtered;
  const frag = document.createDocumentFragment();
  toRender.forEach(ev => frag.appendChild(createEventEl(ev)));
  container.appendChild(frag);

  if (filtered.length > MAX_INITIAL) {
    const btn = document.createElement('button');
    btn.textContent = `Load ${filtered.length - MAX_INITIAL} earlier events`;
    btn.style.cssText = 'margin:8px auto;display:block;padding:7px 16px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;font-size:12px;font-family:Outfit,sans-serif;font-weight:600;';
    btn.onclick = () => {
      btn.remove();
      const earlier = filtered.slice(0, filtered.length - MAX_INITIAL);
      const earlyFrag = document.createDocumentFragment();
      earlier.forEach(ev => earlyFrag.appendChild(createEventEl(ev)));
      container.insertBefore(earlyFrag, container.firstChild);
    };
    container.insertBefore(btn, container.firstChild);
  }
}

function appendEvent(ev) {
  allEvents.push(ev);
  if (activeFilters.size > 0 && !activeFilters.has(ev.event_type)) return;

  const container = document.getElementById('timeline');
  const panel = document.getElementById('timeline-panel');
  const wasAtBottom = panel.scrollHeight - panel.scrollTop - panel.clientHeight < 110;

  container.appendChild(createEventEl(ev));
  if (wasAtBottom) panel.scrollTop = panel.scrollHeight;

  while (container.children.length > 2500) {
    container.removeChild(container.firstChild);
  }
}

function initTokenChart() {
  const ctx = document.getElementById('token-chart').getContext('2d');
  tokenChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Output', data: [], borderColor: '#3dd9a4', backgroundColor: 'rgba(61,217,164,0.08)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1.5 },
        { label: 'Input', data: [], borderColor: '#5cb8ff', backgroundColor: 'rgba(92,184,255,0.08)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1.5 },
        { label: 'Cache Read', data: [], borderColor: '#a07cff', backgroundColor: 'rgba(160,124,255,0.08)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1.5 },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10, family: 'Outfit' }, color: '#6e88a6', padding: 8 } },
        tooltip: {
          backgroundColor: 'rgba(12,18,25,0.92)',
          borderColor: 'rgba(28,46,68,0.6)',
          borderWidth: 1,
          titleFont: { family: 'Outfit', size: 11 },
          bodyFont: { family: 'JetBrains Mono', size: 10 },
          callbacks: { label: ctx => `${ctx.dataset.label}: ${formatTokens(ctx.raw)}` }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(28,46,68,0.3)' }, ticks: { color: '#3e5670', font: { size: 9, family: 'JetBrains Mono' }, maxTicksLimit: 8 } },
        y: { grid: { color: 'rgba(28,46,68,0.3)' }, ticks: { color: '#3e5670', font: { size: 9, family: 'JetBrains Mono' }, callback: v => formatTokens(v) } }
      }
    }
  });
}

function updateTokenChart(cumulative) {
  if (!tokenChart || !cumulative.length) return;
  tokenChart.data.labels = cumulative.map(c => c.step);
  tokenChart.data.datasets[0].data = cumulative.map(c => c.output_tokens);
  tokenChart.data.datasets[1].data = cumulative.map(c => c.input_tokens);
  tokenChart.data.datasets[2].data = cumulative.map(c => c.cache_read);
  tokenChart.update('none');
}

function initToolChart() {
  const ctx = document.getElementById('tool-chart').getContext('2d');
  toolChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10, family: 'Outfit' }, color: '#6e88a6', padding: 6 } },
        tooltip: {
          backgroundColor: 'rgba(12,18,25,0.92)',
          borderColor: 'rgba(28,46,68,0.6)',
          borderWidth: 1,
          titleFont: { family: 'Outfit', size: 11 },
          bodyFont: { family: 'JetBrains Mono', size: 10 },
        }
      }
    }
  });
}

function updateToolChart(breakdown) {
  if (!toolChart) return;
  if (!breakdown || !breakdown.length) {
    toolChart.data.labels = [];
    toolChart.data.datasets[0].data = [];
    toolChart.update('none');
    document.getElementById('tool-table').innerHTML = '';
    return;
  }
  const colors = ['#5cb8ff','#3dd9a4','#a07cff','#ff6a96','#ffaa44','#60e6ff','#5a7490','#ff9a80','#7b94b0','#ff6670'];
  toolChart.data.labels = breakdown.map(b => b.tool);
  toolChart.data.datasets[0].data = breakdown.map(b => b.count);
  toolChart.data.datasets[0].backgroundColor = breakdown.map((_, i) => colors[i % colors.length]);
  toolChart.update('none');

  document.getElementById('tool-table').innerHTML = breakdown.map(b => `
    <tr>
      <td>${escHtml(b.tool)}</td>
      <td>${b.count}</td>
      <td>${b.pct}%</td>
    </tr>
  `).join('');
}

function initActivityChart() {
  const ctx = document.getElementById('activity-chart').getContext('2d');
  activityChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10, family: 'Outfit' }, color: '#6e88a6', padding: 6 } },
        tooltip: {
          backgroundColor: 'rgba(12,18,25,0.92)',
          borderColor: 'rgba(28,46,68,0.6)',
          borderWidth: 1,
          titleFont: { family: 'Outfit', size: 11 },
          bodyFont: { family: 'JetBrains Mono', size: 10 },
        }
      }
    }
  });
}

function updateActivityChart(breakdown) {
  if (!activityChart) return;
  if (!breakdown || !breakdown.length) {
    activityChart.data.labels = [];
    activityChart.data.datasets[0].data = [];
    activityChart.update('none');
    return;
  }
  activityChart.data.labels = breakdown.map(b => (EVENT_TYPES[b.type] || {}).label || b.type);
  activityChart.data.datasets[0].data = breakdown.map(b => b.count);
  activityChart.data.datasets[0].backgroundColor = breakdown.map(b => (EVENT_TYPES[b.type] || {}).color || '#2a3a4e');
  activityChart.update('none');
}

function renderSubmissionNav() {
  const nav = document.getElementById('submissions-list-nav');
  if (!submissionsCache.length) {
    nav.innerHTML = '<div class="no-data">No submissions yet.</div>';
    return;
  }

  nav.innerHTML = `
    <div class="sub-nav-list">
      ${submissionsCache.map((s, idx) => `
        <button class="sub-nav-item ${idx === selectedSubmissionIdx ? 'active' : ''}" data-sub-idx="${idx}">
          <div class="sub-nav-top">
            <span class="sub-nav-version">v${s.version ?? '?'}</span>
            ${s.reviewer_mode === 'subagent' ? '<span class="sub-mode">subagent</span>' : ''}
          </div>
          <div class="sub-nav-time">${escHtml(formatTimestamp(s.timestamp) || 'Unknown time')}</div>
        </button>
      `).join('')}
    </div>
  `;

  nav.querySelectorAll('[data-sub-idx]').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = Number(btn.dataset.subIdx);
      if (Number.isNaN(idx)) return;
      selectedSubmissionIdx = idx;
      renderSubmissionNav();
      renderSubmissionDetail();
    });
  });
}

function renderSubmissionDetail() {
  const container = document.getElementById('submissions-dossier');
  const meta = document.getElementById('dossier-meta');

  if (selectedSubmissionIdx < 0 || selectedSubmissionIdx >= submissionsCache.length) {
    container.innerHTML = '<div class="no-data">Select a submission from the left.</div>';
    meta.textContent = 'Select a submission version.';
    return;
  }

  const s = submissionsCache[selectedSubmissionIdx];
  const review = renderMarkdown(s.review_markdown || s.review || '');
  const rebuttal = s.rebuttal_markdown || s.rebuttal;
  const rebuttalHtml = rebuttal ? renderMarkdown(rebuttal) : '<p class="md-empty">No rebuttal recorded.</p>';
  meta.textContent = `Version v${s.version ?? '?'} \u00B7 ${formatTimestamp(s.timestamp) || 'Unknown time'}`;

  container.innerHTML = `
    <article class="submission-entry">
      <div class="entry-header">
        <span class="sub-version">v${s.version ?? '?'}</span>
        <span class="sub-time">${escHtml(formatTimestamp(s.timestamp) || '')}</span>
        ${s.reviewer_mode === 'subagent' ? '<span class="sub-mode">subagent</span>' : ''}
      </div>
      <div class="submission-body">
        <div class="paper-actions">
          ${s.paper_url ? '<button class="pdf-btn" id="preview-pdf-btn">Preview PDF</button>' : ''}
          ${s.paper_url ? `<a class="pdf-link" href="${encodeURI(s.paper_url)}" target="_blank" rel="noopener noreferrer">Open PDF in new tab</a>` : ''}
          ${!s.paper_url ? '<span class="md-empty">No submission PDF captured for this version.</span>' : ''}
        </div>
        <div class="paper-wrap" id="pdf-preview-wrap" style="display:none;"></div>
        <section class="md-section">
          <h4>Review</h4>
          <div class="md-content">${review}</div>
        </section>
        <section class="md-section">
          <h4>Rebuttal</h4>
          <div class="md-content">${rebuttalHtml}</div>
        </section>
        <div class="sub-badges">
          ${s.has_pdf ? '<span class="sub-badge">PDF</span>' : ''}
          ${s.has_tex ? '<span class="sub-badge">TEX</span>' : ''}
          ${s.has_figures ? `<span class="sub-badge">${s.figures_count || 0} figs</span>` : ''}
        </div>
      </div>
    </article>
  `;

  container.querySelectorAll('.md-content a').forEach(a => {
    a.setAttribute('target', '_blank');
    a.setAttribute('rel', 'noopener noreferrer');
  });

  const previewBtn = document.getElementById('preview-pdf-btn');
  const previewWrap = document.getElementById('pdf-preview-wrap');
  if (previewBtn && previewWrap && s.paper_url) {
    const showPreview = async () => {
      if (!previewWrap.dataset.loaded) {
        previewWrap.innerHTML = '<div class="paper-empty">Loading PDF preview...</div>';
        let rendered = false;
        try {
          const pdfReady = await ensurePdfJs();
          if (pdfReady) {
            rendered = await renderPdfWithPdfJs(s.paper_url, previewWrap);
          }
        } catch (e) {
          console.warn('PDF.js preview failed, using iframe fallback:', e);
        }
        if (!rendered) {
          renderPdfFallback(s.paper_url, previewWrap);
        }
        previewWrap.dataset.loaded = '1';
      }
      previewWrap.style.display = '';
      previewBtn.textContent = 'Hide PDF';
    };

    previewBtn.addEventListener('click', async () => {
      const showing = previewWrap.style.display !== 'none';
      if (showing) {
        previewWrap.style.display = 'none';
        previewBtn.textContent = 'Preview PDF';
        return;
      }
      await showPreview();
    });

    void showPreview();
  }
}

async function loadSubmissions(force = false) {
  if (submissionsLoaded && !force) {
    renderSubmissionNav();
    renderSubmissionDetail();
    return;
  }

  try {
    const resp = await fetch(`/api/jobs/${JOB_ID}/submissions`);
    const data = await resp.json();
    const incoming = data.submissions || [];
    const prevSig = submissionsCache.map(s => `${s.directory || ''}:${s.timestamp || ''}`).join('|');
    const nextSig = incoming.map(s => `${s.directory || ''}:${s.timestamp || ''}`).join('|');
    document.getElementById('stat-subs').textContent = data.total || 0;

    if (submissionsLoaded && force && prevSig === nextSig) {
      return;
    }

    submissionsCache = incoming;
    submissionsLoaded = true;

    if (!submissionsCache.length) {
      selectedSubmissionIdx = -1;
    } else if (selectedSubmissionIdx < 0 || selectedSubmissionIdx >= submissionsCache.length) {
      selectedSubmissionIdx = 0;
    }

    renderSubmissionNav();
    renderSubmissionDetail();
  } catch (e) {
    console.error('Failed to load submissions:', e);
    document.getElementById('submissions-list-nav').innerHTML = '<div class="no-data">Failed to load submissions.</div>';
    document.getElementById('submissions-dossier').innerHTML = '<div class="no-data">Failed to load submissions.</div>';
  }
}

async function loadInitialData() {
  try {
    const ideaLoad = loadIdeaInput();
    const [evResp, tokResp, metaResp] = await Promise.all([
      fetch(`/api/jobs/${JOB_ID}/events`),
      fetch(`/api/jobs/${JOB_ID}/tokens`),
      fetch(`/api/jobs/${JOB_ID}/meta`),
    ]);
    const [evData, tokData, metaData] = await Promise.all([
      evResp.json(),
      tokResp.json(),
      metaResp.json(),
    ]);
    allEvents = evData.events || [];
    lastStep = evData.total_lines || 0;

    if (evData.model) document.getElementById('model-badge').textContent = String(evData.model).replace('claude-', '');
    document.getElementById('stat-events').textContent = allEvents.length;

    renderFilterButtons();
    renderTimeline();
    document.getElementById('timeline-panel').scrollTop = document.getElementById('timeline-panel').scrollHeight;

    if (tokData.cost) {
      document.getElementById('stat-tokens').textContent = formatTokens(tokData.cost.total_tokens);
      document.getElementById('stat-cost').textContent = '$' + (tokData.cost.estimated_cost_usd || 0).toFixed(2);
    }
    updateTokenChart(tokData.cumulative_tokens || []);
    updateToolChart(tokData.tool_breakdown || []);
    updateActivityChart(tokData.event_type_breakdown || []);

    if (metaResp.ok && !metaData.error) {
      const badge = document.getElementById('status-badge');
      badge.textContent = metaData.status;
      badge.className = 'status-badge ' + metaData.status;
      if (metaData.model) {
        document.getElementById('model-badge').textContent = String(metaData.model).replace('claude-', '');
      }
      isLive = metaData.status === 'running';
      document.getElementById('stat-subs').textContent = metaData.submissions || 0;
      if (metaData.gitlab_url) {
        const glLink = document.getElementById('gitlab-link');
        glLink.href = metaData.gitlab_url;
        glLink.style.display = 'inline-block';
      }
    } else {
      document.getElementById('status-badge').className = 'status-badge unknown';
      document.getElementById('status-badge').textContent = 'unknown';
    }

    await ideaLoad;
    if (activeTab === 'submissions') {
      await loadSubmissions();
    }
    if (isLive) startSSE();
  } catch (e) {
    console.error('Failed to load job data:', e);
  }
}

function startSSE() {
  if (evtSource) evtSource.close();

  evtSource = new EventSource(`/api/jobs/${JOB_ID}/stream?after=${lastStep}`);

  evtSource.addEventListener('new_event', (e) => {
    startSSE._failures = 0;
    const event = JSON.parse(e.data);
    appendEvent(event);
    lastStep = Math.max(lastStep, (event.line_num || 0) + 1);
    document.getElementById('stat-events').textContent = allEvents.length;
    renderFilterButtons();
  });

  evtSource.addEventListener('metrics', (e) => {
    const m = JSON.parse(e.data);
    if (m.cost) {
      document.getElementById('stat-tokens').textContent = formatTokens(m.cost.total_tokens);
      document.getElementById('stat-cost').textContent = '$' + (m.cost.estimated_cost_usd || 0).toFixed(2);
    }
    updateToolChart(m.tool_breakdown || []);
    updateActivityChart(m.event_type_breakdown || []);
    if (typeof m.total_lines === 'number') lastStep = Math.max(lastStep, m.total_lines);
  });

  evtSource.onerror = (e) => {
    evtSource.close();
    // Don't retry if we got a non-retryable error (404 in gitlab mode, etc).
    // EventSource fires onerror on HTTP errors before readyState goes to CLOSED.
    // After 3 consecutive failures, stop retrying to avoid log spam.
    if (!isLive) return;
    if (!startSSE._failures) startSSE._failures = 0;
    startSSE._failures++;
    if (startSSE._failures > 3) {
      isLive = false;
      return;
    }
    setTimeout(() => startSSE(), 5000);
  };

  if (tokenRefreshTimer) clearInterval(tokenRefreshTimer);
  tokenRefreshTimer = setInterval(async () => {
    if (!isLive) return;
    try {
      const tokResp = await fetch(`/api/jobs/${JOB_ID}/tokens`);
      const tokData = await tokResp.json();
      updateTokenChart(tokData.cumulative_tokens || []);
      if (activeTab === 'submissions') {
        await loadSubmissions(true);
      }
    } catch (_) {}
  }, 12000);
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
  });
  const ideaToggle = document.getElementById('idea-view-toggle');
  if (ideaToggle) {
    ideaToggle.addEventListener('click', () => {
      if (!ideaCanToggle) return;
      ideaViewMode = ideaViewMode === 'raw' ? 'pretty' : 'raw';
      updateIdeaView();
    });
  }

  initTokenChart();
  initToolChart();
  initActivityChart();
  loadInitialData();
});
</script>
</body>
</html>
