<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Scientist v3 — Job Monitor</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg0: #060a10;
  --bg1: #0c1219;
  --surface: #111c2b;
  --surface2: #182838;
  --surface3: #1f3248;
  --border: #1c2e44;
  --border-hover: #2c4a6a;
  --text: #e2ecf6;
  --text-dim: #6e88a6;
  --text-muted: #3e5670;
  --accent: #5cb8ff;
  --accent-glow: rgba(92,184,255,0.15);
  --accent2: #3dd9a4;
  --accent2-glow: rgba(61,217,164,0.12);
  --warm: #ffaa44;
  --danger: #ff6670;
  --purple: #a07cff;
  --pink: #ff6a96;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  min-height: 100vh;
  font-family: 'Outfit', sans-serif;
  color: var(--text);
  background: var(--bg0);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Layered background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 1400px 600px at 10% -8%, rgba(92,184,255,0.12), transparent 65%),
    radial-gradient(ellipse 1000px 500px at 90% -5%, rgba(61,217,164,0.08), transparent 60%),
    radial-gradient(ellipse 600px 400px at 50% 100%, rgba(160,124,255,0.06), transparent 60%);
  pointer-events: none;
  z-index: 0;
}

/* Noise grain overlay */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  opacity: 0.028;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  background-size: 256px 256px;
  pointer-events: none;
  z-index: 9998;
}

.container {
  position: relative;
  z-index: 1;
  max-width: 1560px;
  margin: 0 auto;
  padding: 28px 24px 40px;
}

/* ─── Header ─── */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  padding: 18px 22px;
  border: 1px solid var(--border);
  border-radius: 16px;
  background: linear-gradient(180deg, rgba(17,28,43,0.92), rgba(12,18,25,0.82));
  backdrop-filter: blur(12px);
  box-shadow:
    0 1px 0 0 rgba(255,255,255,0.03) inset,
    0 16px 48px rgba(0,0,0,0.4);
}

header h1 {
  display: flex;
  flex-wrap: wrap;
  align-items: baseline;
  gap: 8px;
  font-size: 22px;
  font-weight: 700;
  letter-spacing: -0.01em;
}

header h1 .brand {
  font-family: 'Crimson Pro', serif;
  font-weight: 700;
  font-size: 26px;
  letter-spacing: -0.02em;
}

header h1 .label {
  color: var(--accent);
  font-weight: 600;
  font-size: 15px;
  letter-spacing: 0.06em;
  text-transform: uppercase;
}

.title-meta {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-left: 4px;
}

.title-meta a {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.04em;
  color: var(--text-dim);
  text-decoration: none;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 3px 10px;
  background: rgba(28,46,68,0.4);
  transition: all 0.15s ease;
}

.title-meta a:hover {
  border-color: var(--accent);
  color: var(--text);
  background: var(--accent-glow);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 14px;
}

.mini-stats {
  display: flex;
  gap: 18px;
}

.mini-stat {
  text-align: right;
}

.mini-stat-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -0.03em;
  color: var(--text);
  line-height: 1.1;
}

.mini-stat-val.running { color: var(--accent2); }
.mini-stat-val.cost { color: var(--warm); }

.mini-stat-label {
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-top: 1px;
}

.refresh-badge {
  color: var(--text-muted);
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  border: 1px solid rgba(28,46,68,0.6);
  border-radius: 6px;
  padding: 5px 10px;
  background: rgba(17,28,43,0.5);
  white-space: nowrap;
}

/* ─── Search ─── */
.search-bar {
  margin-top: 14px;
  position: relative;
}

.search-bar svg {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  color: var(--text-muted);
  pointer-events: none;
}

.search-bar input {
  width: 100%;
  padding: 11px 14px 11px 40px;
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  background: rgba(17,28,43,0.7);
  border: 1px solid var(--border);
  border-radius: 10px;
  outline: none;
  transition: all 0.15s ease;
}

.search-bar input::placeholder {
  color: var(--text-muted);
}

.search-bar input:focus {
  border-color: var(--accent);
  background: rgba(17,28,43,0.9);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.search-kbd {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  align-items: center;
  gap: 3px;
  pointer-events: none;
  transition: opacity 0.15s ease;
}

.search-kbd kbd {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 500;
  color: var(--text-muted);
  background: rgba(28,46,68,0.5);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1px 5px;
  line-height: 1.5;
}

.search-bar input:focus ~ .search-kbd {
  opacity: 0;
}

/* ─── Filters ─── */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin: 12px 0;
}

.filter-btn {
  border: 1px solid var(--border);
  border-radius: 8px;
  background: rgba(24,40,56,0.5);
  color: var(--text-dim);
  padding: 6px 12px;
  font-family: 'Outfit', sans-serif;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.02em;
  cursor: pointer;
  transition: all 0.15s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.filter-btn:hover {
  border-color: var(--border-hover);
  color: var(--text);
  background: rgba(28,46,68,0.6);
}

.filter-btn.active {
  background: var(--accent-glow);
  border-color: rgba(92,184,255,0.4);
  color: var(--text);
}

.filter-btn .count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  opacity: 0.7;
}

/* ─── Table ─── */
.jobs-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
  background: linear-gradient(180deg, rgba(17,28,43,0.88), rgba(12,18,25,0.75));
  box-shadow:
    0 1px 0 0 rgba(255,255,255,0.02) inset,
    0 12px 40px rgba(0,0,0,0.32);
}

.jobs-table th {
  text-align: left;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-muted);
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  background: rgba(24,40,56,0.5);
  cursor: pointer;
  user-select: none;
  transition: color 0.15s ease;
  white-space: nowrap;
}

.jobs-table th:hover { color: var(--accent); }

.jobs-table th .sort-arrow {
  display: inline-block;
  margin-left: 4px;
  font-size: 9px;
  opacity: 0;
  transition: opacity 0.15s ease;
}

.jobs-table th.sorted .sort-arrow { opacity: 1; }

.jobs-table td {
  padding: 14px 16px;
  border-bottom: 1px solid rgba(28,46,68,0.45);
  font-size: 13px;
  transition: background 0.12s ease;
}

.jobs-table tr:last-child td { border-bottom: 0; }

.jobs-table tbody tr {
  cursor: pointer;
  position: relative;
}

.jobs-table tbody tr:hover td {
  background: rgba(92,184,255,0.04);
}

.jobs-table tbody tr:hover td:first-child {
  box-shadow: inset 3px 0 0 var(--accent);
}

/* Row stagger animation */
@keyframes rowFadeIn {
  from {
    opacity: 0;
    transform: translateY(6px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.jobs-table tbody tr {
  animation: rowFadeIn 0.25s ease both;
}

/* Status indicators */
.status {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  font-weight: 600;
  text-transform: capitalize;
  font-size: 12px;
}

.status-dot {
  position: relative;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-running .status-dot {
  background: var(--accent2);
  box-shadow: 0 0 6px var(--accent2);
}

.status-running .status-dot::after {
  content: '';
  position: absolute;
  inset: -4px;
  border-radius: 50%;
  border: 1.5px solid var(--accent2);
  opacity: 0;
  animation: ringPulse 2s ease-out infinite;
}

@keyframes ringPulse {
  0% { opacity: 0.6; transform: scale(0.8); }
  100% { opacity: 0; transform: scale(1.6); }
}

.status-completed .status-dot { background: #5e7a96; }
.status-idle .status-dot { background: var(--warm); box-shadow: 0 0 6px rgba(255,170,68,0.3); }
.status-unknown .status-dot { background: var(--text-muted); }

/* Badges */
.model-badge {
  display: inline-block;
  background: var(--accent-glow);
  color: var(--accent);
  padding: 3px 9px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.02em;
}

.tokens-cell, .cost-cell, .duration-cell {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  font-weight: 500;
}

.cost-cell { color: var(--warm); }
.duration-cell { color: var(--text-dim); white-space: nowrap; }

.task-name {
  color: var(--text-dim);
  max-width: 440px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.submissions-badge {
  display: inline-block;
  background: var(--accent2-glow);
  color: var(--accent2);
  border-radius: 6px;
  padding: 3px 9px;
  font-size: 11px;
  font-weight: 600;
}

/* States */
.loading, .empty-state {
  text-align: center;
  color: var(--text-dim);
  padding: 40px 20px;
}

.empty-state-icon {
  display: block;
  margin: 0 auto 12px;
  width: 48px;
  height: 48px;
  opacity: 0.3;
}

/* Keyboard hints */
.kbd-hints {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-top: 16px;
  opacity: 0.5;
  transition: opacity 0.2s ease;
}

.kbd-hints:hover { opacity: 0.8; }

.kbd-hint {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  color: var(--text-muted);
}

.kbd-hint kbd {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 500;
  background: rgba(28,46,68,0.5);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1px 5px;
  line-height: 1.5;
  color: var(--text-dim);
}

/* Responsive */
@media (max-width: 1100px) {
  .mini-stats { display: none; }
}

@media (max-width: 900px) {
  header {
    flex-direction: column;
    align-items: flex-start;
  }
  .header-right { width: 100%; justify-content: space-between; }
  .refresh-badge { text-align: center; }
  .jobs-table th:nth-child(8),
  .jobs-table td:nth-child(8) { display: none; }
}

@media (max-width: 640px) {
  .container { padding: 14px 10px 24px; }
  header { padding: 14px; }
  .jobs-table th:nth-child(4), .jobs-table td:nth-child(4),
  .jobs-table th:nth-child(5), .jobs-table td:nth-child(5) { display: none; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(56,84,112,0.6); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(56,84,112,0.9); }

/* Focus visible */
:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Selection */
::selection {
  background: rgba(92,184,255,0.25);
  color: var(--text);
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>
      <span class="brand">AI Scientist</span> <span class="label">Job Monitor</span>
      <span class="title-meta">
        <a href="https://github.com/findalexli/ai-scientist-v3" target="_blank" rel="noopener noreferrer">Repo</a>
        <a href="https://github.com/findalexli" target="_blank" rel="noopener noreferrer">@findalexli</a>
      </span>
    </h1>
    <div class="header-right">
      <div class="mini-stats">
        <div class="mini-stat">
          <div class="mini-stat-val" id="stat-total">-</div>
          <div class="mini-stat-label">Jobs</div>
        </div>
        <div class="mini-stat">
          <div class="mini-stat-val running" id="stat-running">-</div>
          <div class="mini-stat-label">Running</div>
        </div>
        <div class="mini-stat">
          <div class="mini-stat-val cost" id="stat-total-cost">-</div>
          <div class="mini-stat-label">Total Cost</div>
        </div>
      </div>
      <div class="refresh-badge" id="refresh-info">Loading...</div>
    </div>
  </header>

  <div class="search-bar">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="search-input" placeholder="Search jobs by name, model, or task..." autocomplete="off" spellcheck="false">
    <span class="search-kbd"><kbd>/</kbd></span>
  </div>

  <div class="filters" id="filters"></div>

  <table class="jobs-table" id="jobs-table">
    <thead>
      <tr>
        <th data-sort="status">Status <span class="sort-arrow"></span></th>
        <th data-sort="id">Job <span class="sort-arrow"></span></th>
        <th data-sort="model">Model <span class="sort-arrow"></span></th>
        <th data-sort="duration">Duration <span class="sort-arrow"></span></th>
        <th data-sort="tokens">Tokens <span class="sort-arrow"></span></th>
        <th data-sort="cost">Cost <span class="sort-arrow"></span></th>
        <th data-sort="submissions">Subs <span class="sort-arrow"></span></th>
        <th>Task</th>
      </tr>
    </thead>
    <tbody id="jobs-body">
      <tr><td colspan="8" class="loading">Loading jobs...</td></tr>
    </tbody>
  </table>

  <div class="kbd-hints">
    <span class="kbd-hint"><kbd>/</kbd> Search</span>
    <span class="kbd-hint"><kbd>j</kbd><kbd>k</kbd> Navigate</span>
    <span class="kbd-hint"><kbd>Enter</kbd> Open</span>
  </div>
</div>

<script>
let allJobs = [];
let currentFilter = 'all';
let sortKey = 'id';
let sortAsc = false;
let hideDateOnlyJobs = true;
let searchQuery = '';
let focusedRowIdx = -1;

function formatTokens(n) {
  if (!n) return '-';
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1_000) return (n / 1_000).toFixed(0) + 'K';
  return String(n);
}

function formatDuration(seconds) {
  if (seconds === null || seconds === undefined) return '-';
  const s = Math.max(0, Math.floor(Number(seconds) || 0));
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const ss = s % 60;
  if (h > 0) return `${h}h ${m}m`;
  if (m > 0) return `${m}m ${ss}s`;
  return `${ss}s`;
}

function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function isDateOnlyJobId(jobId) {
  return /^\d{4}-\d{2}-\d{2}__\d{2}-\d{2}-\d{2}$/.test(String(jobId || ''));
}

function getVisibleJobs() {
  let jobs = hideDateOnlyJobs ? allJobs.filter(j => !isDateOnlyJobId(j.id)) : [...allJobs];
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    jobs = jobs.filter(j =>
      (j.id || '').toLowerCase().includes(q) ||
      (j.model || '').toLowerCase().includes(q) ||
      (j.task_name || '').toLowerCase().includes(q)
    );
  }
  return jobs;
}

function updateMiniStats() {
  const visible = getVisibleJobs();
  const running = visible.filter(j => j.status === 'running').length;
  const totalCost = visible.reduce((sum, j) => sum + (j.tokens?.estimated_cost_usd || 0), 0);

  document.getElementById('stat-total').textContent = visible.length;
  document.getElementById('stat-running').textContent = running || '0';
  document.getElementById('stat-total-cost').textContent = totalCost > 0 ? '$' + totalCost.toFixed(2) : '-';
}

function renderFilters() {
  const visibleJobs = getVisibleJobs();
  const counts = { all: visibleJobs.length, running: 0, completed: 0, idle: 0, unknown: 0 };
  visibleJobs.forEach(j => { counts[j.status] = (counts[j.status] || 0) + 1; });

  const filtersEl = document.getElementById('filters');
  filtersEl.innerHTML = '';
  ['all', 'running', 'completed', 'idle', 'unknown'].forEach(f => {
    if (f !== 'all' && !counts[f]) return;
    const btn = document.createElement('button');
    btn.className = 'filter-btn' + (currentFilter === f ? ' active' : '');
    btn.innerHTML = `${f.charAt(0).toUpperCase() + f.slice(1)}<span class="count">${counts[f] || 0}</span>`;
    btn.onclick = () => { currentFilter = f; renderFilters(); renderTable(); };
    filtersEl.appendChild(btn);
  });

  const toggle = document.createElement('button');
  toggle.className = 'filter-btn' + (hideDateOnlyJobs ? ' active' : '');
  toggle.textContent = hideDateOnlyJobs ? 'Date-only Hidden' : 'Date-only Visible';
  toggle.onclick = () => {
    hideDateOnlyJobs = !hideDateOnlyJobs;
    renderFilters();
    renderTable();
    updateMiniStats();
  };
  filtersEl.appendChild(toggle);
}

function updateSortIndicators() {
  document.querySelectorAll('.jobs-table th[data-sort]').forEach(th => {
    const arrow = th.querySelector('.sort-arrow');
    if (th.dataset.sort === sortKey) {
      th.classList.add('sorted');
      arrow.textContent = sortAsc ? '\u25B2' : '\u25BC';
    } else {
      th.classList.remove('sorted');
      arrow.textContent = '';
    }
  });
}

function renderTable() {
  const visibleJobs = getVisibleJobs();
  let jobs = currentFilter === 'all' ? [...visibleJobs] : visibleJobs.filter(j => j.status === currentFilter);

  jobs.sort((a, b) => {
    let va, vb;
    switch (sortKey) {
      case 'tokens':
        va = a.tokens?.total_tokens || 0;
        vb = b.tokens?.total_tokens || 0;
        break;
      case 'cost':
        va = a.tokens?.estimated_cost_usd || 0;
        vb = b.tokens?.estimated_cost_usd || 0;
        break;
      case 'submissions':
        va = a.submissions || 0;
        vb = b.submissions || 0;
        break;
      case 'duration':
        va = a.duration_seconds || 0;
        vb = b.duration_seconds || 0;
        break;
      default:
        va = a[sortKey] || '';
        vb = b[sortKey] || '';
    }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });

  const tbody = document.getElementById('jobs-body');
  if (!jobs.length) {
    tbody.innerHTML = `<tr><td colspan="8" class="empty-state">
      <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      ${searchQuery ? 'No jobs match your search.' : 'No jobs found.'}
    </td></tr>`;
    return;
  }

  focusedRowIdx = -1;
  tbody.innerHTML = jobs.map((j, i) => `
    <tr data-idx="${i}" data-job-id="${escHtml(j.id)}" onclick="window.location='/job/${encodeURIComponent(j.id)}'" style="animation-delay:${Math.min(i * 0.025, 0.5)}s">
      <td>
        <span class="status status-${escHtml(j.status)}">
          <span class="status-dot"></span>
          ${escHtml(j.status)}
        </span>
      </td>
      <td style="font-weight:600">${escHtml(j.id)}</td>
      <td><span class="model-badge">${escHtml(j.model || 'unknown')}</span></td>
      <td class="duration-cell">${formatDuration(j.duration_seconds)}</td>
      <td class="tokens-cell">${formatTokens(j.tokens?.total_tokens)}</td>
      <td class="cost-cell">${j.tokens?.estimated_cost_usd ? '$' + Number(j.tokens.estimated_cost_usd).toFixed(2) : '-'}</td>
      <td>${j.submissions ? '<span class="submissions-badge">v' + j.submissions + '</span>' : '-'}</td>
      <td class="task-name" title="${escHtml(j.task_name || '')}">${escHtml(j.task_name || '-')}</td>
    </tr>
  `).join('');

  updateSortIndicators();
  updateMiniStats();
}

async function fetchJobs() {
  try {
    const resp = await fetch('/api/jobs');
    allJobs = await resp.json();
    renderFilters();
    renderTable();
    document.getElementById('refresh-info').textContent =
      `${allJobs.length} jobs \u00B7 ${new Date().toLocaleTimeString()}`;
  } catch (e) {
    document.getElementById('jobs-body').innerHTML =
      '<tr><td colspan="8" class="empty-state">Error loading jobs.</td></tr>';
  }
}

/* Sort handlers */
document.querySelectorAll('.jobs-table th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.sort;
    if (sortKey === key) sortAsc = !sortAsc;
    else { sortKey = key; sortAsc = true; }
    renderTable();
  });
});

/* Search */
const searchInput = document.getElementById('search-input');
let searchTimeout;
searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    searchQuery = searchInput.value.trim();
    renderFilters();
    renderTable();
  }, 200);
});

/* Keyboard shortcuts */
document.addEventListener('keydown', (e) => {
  /* / to focus search */
  if (e.key === '/' && document.activeElement !== searchInput) {
    e.preventDefault();
    searchInput.focus();
    return;
  }

  /* Escape to blur search */
  if (e.key === 'Escape' && document.activeElement === searchInput) {
    searchInput.blur();
    return;
  }

  /* j/k navigation (only when not in search) */
  if (document.activeElement === searchInput) return;

  const rows = document.querySelectorAll('#jobs-body tr[data-idx]');
  if (!rows.length) return;

  if (e.key === 'j' || e.key === 'ArrowDown') {
    e.preventDefault();
    focusedRowIdx = Math.min(focusedRowIdx + 1, rows.length - 1);
    highlightRow(rows);
  } else if (e.key === 'k' || e.key === 'ArrowUp') {
    e.preventDefault();
    focusedRowIdx = Math.max(focusedRowIdx - 1, 0);
    highlightRow(rows);
  } else if (e.key === 'Enter' && focusedRowIdx >= 0 && focusedRowIdx < rows.length) {
    e.preventDefault();
    rows[focusedRowIdx].click();
  }
});

function highlightRow(rows) {
  rows.forEach((r, i) => {
    if (i === focusedRowIdx) {
      r.style.background = 'rgba(92,184,255,0.08)';
      r.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    } else {
      r.style.background = '';
    }
  });
}

fetchJobs();
setInterval(fetchJobs, 10000);
</script>
</body>
</html>
